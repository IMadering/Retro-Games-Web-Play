!function(t){function e(e){for(var i,a,o=e[0],h=e[1],c=e[2],u=0,d=[];u<o.length;u++)a=o[u],r[a]&&d.push(r[a][0]),r[a]=0;for(i in h)Object.prototype.hasOwnProperty.call(h,i)&&(t[i]=h[i]);for(l&&l(e);d.length;)d.shift()();return n.push.apply(n,c||[]),s()}function s(){for(var t,e=0;e<n.length;e++){for(var s=n[e],i=!0,o=1;o<s.length;o++){var h=s[o];0!==r[h]&&(i=!1)}i&&(n.splice(e--,1),t=a(a.s=s[0]))}return t}var i={},r={1:0},n=[];function a(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=t,a.c=i,a.d=function(t,e,s){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)a.d(s,i,function(e){return t[e]}.bind(null,i));return s},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="";var o=window.webpackJsonp=window.webpackJsonp||[],h=o.push.bind(o);o.push=e,o=o.slice();for(var c=0;c<o.length;c++)e(o[c]);var l=h;n.push([101,0]),s()}({0:function(t,e,s){"use strict";(function(t){s.d(e,"a",function(){return n});const i="undefined"!=typeof btoa?btoa:function(e){return(e instanceof t?e:t.from(e.toString(),"binary")).toString("base64")},r="undefined"!=typeof atob?atob:function(e){return new t(e,"base64").toString("binary")};class n{static hex(t,e=2){const s=t.toString(16),i=s.length-e;if(i>0)return s.substring(i);if(0===i)return s;return"0000000".substring("0000000".length+i)+s}static clamp(t,e,s){return t<e?e:t>s?s:t}static getExt(t){const e=t.lastIndexOf(".");return e>=0?t.slice(e+1):""}static convertUint8ArrayToBase64String(t){const e=Array.from(t).map(t=>String.fromCharCode(t)).join("");return i(e)}static convertBase64StringToUint8Array(t){const e=r(t),s=new Array(e.length);for(let t=0;t<e.length;++t)s[t]=e.charCodeAt(t);return new Uint8Array(s)}}}).call(this,s(7).Buffer)},1:function(t,e,s){"use strict";s.d(e,"a",function(){return i});class i{static clearCanvas(t){const e=t.getContext("2d");null!=e&&(e.strokeStyle="",e.fillStyle="rgb(64,64,64)",e.fillRect(0,0,t.width,t.height))}static removeAllChildren(t){for(let e of t.childNodes)t.removeChild(e)}static setStyles(t,e){Object.assign(t.style,e)}static loadFile(t){return new Promise((e,s)=>{const i=new FileReader;i.onload=function(t){const s=new Uint8Array(t.target.result);e(s)},i.onerror=function(t){s(i.error)},i.readAsArrayBuffer(t)})}static handleFileDrop(t,e){t.addEventListener("dragover",function(t){return t.dataTransfer&&(t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"),!1},!1),t.addEventListener("drop",function(t){if(t.dataTransfer){t.stopPropagation(),t.preventDefault();const s=t.dataTransfer.files;s.length>0&&e(s,t.pageX,t.pageY)}return!1},!1)}static getCanvasContext2d(t){const e=t.getContext("2d");if(null==e)throw new Error("2d context not supported or canvas already initialized");return e}static timeout(t){return new Promise(e=>setTimeout(e,t))}static download(t,e){const s=window.URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.setAttribute("download",e),i.click()}static chooseFile(t){const e=document.createElement("input");e.setAttribute("type","file"),e.setAttribute("accept",".sav, application/json"),e.addEventListener("change",function(e){t(e.target.files)}),e.click()}static setMouseDragListener(t,e,s){let i=null,r=null;if("object"==typeof t){const n=t;t=n.move,e=n.up,i=n.leave,s=n.useCapture,r=null==i?null:n.leaveTarget||document}const n=()=>{document.removeEventListener("mousemove",t,s),document.removeEventListener("mouseup",a,s),o&&r&&r.removeEventListener("mouseleave",o,s)},a=t=>{e&&e(t),n()},o=null==i?null:t=>{i&&i(t)&&n()};document.addEventListener("mousemove",t,s),document.addEventListener("mouseup",a,s),o&&r&&r.addEventListener("mouseleave",o,s)}static getMousePosIn(t,e){const s=e.getBoundingClientRect(),i=document.body.scrollLeft,r=document.body.scrollTop;return[t.pageX-s.left-i,t.pageY-s.top-r]}}},100:function(t,e){"fill"in Array.prototype||(Array.prototype.fill=function(t,e=0,s){void 0===s&&(s=this.length);for(let i=e;i<s;++i)this[i]=t;return this}),"fill"in Uint8Array.prototype||(Uint8Array.prototype.fill=function(t,e=0,s){void 0===s&&(s=this.length);for(let i=e;i<s;++i)this[i]=t;return this}),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(t,e){void 0===e&&(e=this.length);const s=new Uint8Array(e-t);for(let e=0;e<s.length;++e)s[e]=this[e+t];return s})},101:function(t,e,s){"use strict";s.r(e);var i=s(18),r=s(12),n=s(1),a=s(61),o=s(6),h=s(4);const c=["A","B","SELECT","START","U","D","L","R"];class l{static setUp(){l.initialized||(l.loadSetting(),l.initialized=!0)}static isSupported(){return"Gamepad"in window}static getState(t){if(!l.isSupported())return 0;const e=navigator.getGamepads();if(t>=e.length)return 0;const s=e[t];if(!s)return 0;const i=l.AXIS_THRESHOLD;let r=0;return l.padSettings.forEach((t,e)=>{switch(t.type){case 0:(s.axes[t.index]||0)*t.direction>=i&&(r|=1<<e);break;case 1:const n=s.buttons[t.index];n&&n.pressed&&(r|=1<<e)}}),r}static setButton(t,e){l.padSettings[t].type=1,l.padSettings[t].index=e,l.padSettings[t].direction=1,l.saveSetting()}static setAxis(t,e,s){l.padSettings[t].type=0,l.padSettings[t].index=e,l.padSettings[t].direction=s,l.saveSetting()}static saveSetting(){const t={};l.padSettings.forEach((e,s)=>{const i=c[s];switch(e.type){default:break;case 1:t[i]={button:e.index};break;case 0:t[i]={axis:e.index,direction:e.direction}}}),o.a.putObject("pad0",t)}static loadSetting(){const t=o.a.getObject("pad0",{});"object"==typeof t&&Object.keys(t).forEach(e=>{const s=c.indexOf(e.toUpperCase());if(s<0)return;const i=t[e];"button"in i?l.setButton(s,i.button):"axis"in i&&"direction"in i&&l.setAxis(s,i.axis,parseInt(i.direction,10))})}}l.AXIS_THRESHOLD=.5,l.initialized=!1,l.padSettings=[{type:1,index:0,direction:1},{type:1,index:1,direction:1},{type:1,index:2,direction:1},{type:1,index:3,direction:1},{type:0,index:1,direction:-1},{type:0,index:1,direction:1},{type:0,index:0,direction:-1},{type:0,index:0,direction:1}];const u=[{x:40,y:10,name:"&uarr;",padbit:4},{x:10,y:40,name:"&larr;",padbit:6},{x:70,y:40,name:"&rarr;",padbit:7},{x:40,y:70,name:"&darr;",padbit:5},{x:130,y:40,name:"B",opt:{type:"round"},padbit:1},{x:175,y:40,name:"A",opt:{type:"round"},padbit:0},{x:50,y:110,name:"Select",opt:{width:60,height:20},padbit:2},{x:120,y:110,name:"Start",opt:{width:60,height:20},padbit:3}];class d extends h.a{constructor(t,e){super(t,230,150,"Gamepad config"),this.onClose=e,this.destroying=!1,this.selectedButton=null;const s=document.createElement("div");s.className="gamepad-content",n.a.setStyles(s,{width:"230px",height:"150px"}),this.setContent(s),s.addEventListener("click",()=>{this.setSelectedButton(null)}),this.buttons=u.map(t=>{const e=function(t,e,s,i,r={}){const a=document.createElement("div");return a.className="gamepad-btn",n.a.setStyles(a,{left:`${e}px`,top:`${s}px`,width:`${r.width||30}px`,height:`${r.height||30}px`}),a.innerHTML=i,"round"===r.type&&(a.style.borderRadius="15px"),t.appendChild(a),a}(s,t.x,t.y,t.name,t.opt);return e.addEventListener("click",t=>{t.stopPropagation(),this.setSelectedButton(e)}),e}),this.selectedButton=null;const i=()=>{this.destroying||(this.checkGamepad(),requestAnimationFrame(i))};requestAnimationFrame(i)}close(){this.destroying=!0,null!=this.onClose&&this.onClose(),super.close()}checkGamepad(){if(!window.Gamepad)return;const t=navigator.getGamepads();if(0>=t.length)return;const e=t[0];if(e){if(null!=this.selectedButton&&this.isTop()){const t=this.buttons.indexOf(this.selectedButton);this.replaceGamepadButton(0,e,t)&&this.setSelectedButton(null)}this.checkGamepadPressed(0)}}replaceGamepadButton(t,e,s){for(let t=0;t<e.buttons.length;++t)if(e.buttons[t].pressed)return l.setButton(u[s].padbit,t),!0;const i=l.AXIS_THRESHOLD;for(let t=0;t<e.axes.length;++t){const r=e.axes[t];if(r<-i)return l.setAxis(u[s].padbit,t,-1),!0;if(r>i)return l.setAxis(u[s].padbit,t,1),!0}return!1}checkGamepadPressed(t){const e=l.getState(t);for(let t=0;t<u.length;++t){const s=this.buttons[t];0==(e&1<<u[t].padbit)?s.classList.remove("pressed"):s.classList.add("pressed")}}setSelectedButton(t){null!=this.selectedButton&&this.selectedButton.classList.remove("selected"),this.selectedButton!==t?(this.selectedButton=t,null!=this.selectedButton&&this.selectedButton.classList.add("selected")):this.selectedButton=null}}var p=s(0);const g={37:{no:0,bit:64},39:{no:0,bit:128},38:{no:0,bit:16},40:{no:0,bit:32},90:{no:0,bit:2},88:{no:0,bit:1},32:{no:0,bit:4},13:{no:0,bit:8},74:{no:1,bit:64},76:{no:1,bit:128},73:{no:1,bit:16},75:{no:1,bit:32},81:{no:1,bit:2},87:{no:1,bit:1},79:{no:1,bit:4},80:{no:1,bit:8}};class m{constructor(){this.controller=new Uint8Array(2)}onKeyDown(t){const e=g[t];e&&(this.controller[e.no]|=e.bit)}onKeyUp(t){const e=g[t];e&&(this.controller[e.no]&=~e.bit)}getStatus(t){return this.controller[t]}clearAll(){this.controller.fill(0)}}var f=function(t,e,s,i){return new(s||(s=Promise))(function(r,n){function a(t){try{h(i.next(t))}catch(t){n(t)}}function o(t){try{h(i.throw(t))}catch(t){n(t)}}function h(t){t.done?r(t.value):new s(function(e){e(t.value)}).then(a,o)}h((i=i.apply(t,e||[])).next())})};const b=100;function k(t,e,s){t.getRootNode().style.zIndex=String(b+(s-1-e))}class w{constructor(t){this.root=t,this.windows=[],this.padKeyHandler=new m,this.pressingKeys={},this.onKeyDown=t=>{t.ctrlKey&&87===t.keyCode?this.windows.length>0&&this.windows[0].close():t.ctrlKey||t.altKey||t.metaKey||(t.preventDefault(),this.padKeyHandler.onKeyDown(t.keyCode),this.pressingKeys[t.keyCode]=!0)},this.onKeyUp=t=>{t.preventDefault(),this.padKeyHandler.onKeyUp(t.keyCode),this.pressingKeys[t.keyCode]=!1},this.root.addEventListener("keydown",this.onKeyDown),this.root.addEventListener("keyup",this.onKeyUp),this.root.focus(),this.setUpBlur()}getPadStatus(t,e){return t.isTop()?this.padKeyHandler.getStatus(e)|l.getState(e):0}getKeyPressing(t,e){return t.isTop()&&this.pressingKeys[e]}add(t){this.windows.unshift(t),this.root.appendChild(t.getRootNode()),this.updateWindowPriorities()}remove(t){this.removeWnd(t);const e=t.getRootNode();null!=e&&null!=e.parentNode&&e.parentNode.removeChild(e)}showSnackbar(t,e={}){return f(this,void 0,void 0,function*(){const s=e.wait||3e3,i=e.type||"danger",r=document.createElement("div");r.className="snackbar-container",r.style.zIndex="10000";const a=document.createElement("div");a.className=`snackbar-box ${i}`,r.appendChild(a);const o=document.createTextNode(t);a.appendChild(o),this.root.appendChild(r),yield n.a.timeout(20),r.style.top="8px",yield n.a.timeout(s),r.style.top="-32px",yield n.a.timeout(500),this.root.removeChild(r)})}moveToTop(t){const e=this.windows.length;if(e>0&&this.windows[0]===t)return;let s=t;for(let i=0;i<e;++i){const e=this.windows[i];if(this.windows[i]=s,e===t)break;s=e}this.updateWindowPriorities()}setFullscreen(t,e){const s=[{fullscreen:"requestFullscreen",change:"fullscreenchange"},{fullscreen:"webkitRequestFullScreen",change:"webkitfullscreenchange"},{fullscreen:"mozRequestFullScreen",change:"mozfullscreenchange"},{fullscreen:"msRequestFullscreen",change:"MSFullscreenChange"}];for(let i=0;i<s.length;++i)if(t[s[i].fullscreen]){t[s[i].fullscreen]();const r=s[i].change,n=()=>{const s=!!(document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen);s?(t.setAttribute("tabindex","1"),t.style.cursor="none",t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp)):(t.removeAttribute("tabindex"),t.style.cursor="",t.removeEventListener("keydown",this.onKeyDown),t.removeEventListener("keyup",this.onKeyUp)),e&&e(s),s?t.focus():(document.removeEventListener(r,n,!1),this.root.focus())};return document.addEventListener(r,n,!1),!0}return!1}removeWnd(t){const e=this.windows.indexOf(t);e<0||(this.windows.splice(e,1),this.updateWindowPriorities())}updateWindowPriorities(){const t=this.windows.length;for(let e=0;e<t;++e){let s=this.windows[e];s.setTop(0===e),k(s,e,t)}}setUpBlur(){window.addEventListener("blur",()=>{for(let t of Object.keys(this.pressingKeys))delete this.pressingKeys[t];this.padKeyHandler.clearAll()})}}s(100);var C=s(33);window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;const y="volume";class B{constructor(t){this.root=t,this.apps=[],this.volume=1,this.gamepadWnd=null,this.globalPaletWnd=null,this.wndMgr=new w(t),this.volume=p.a.clamp(o.a.getFloat(y,1),0,1),this.setUpPaletLink(),this.setUpGamePadLink(),this.setUpVolumeLink(),this.setUpOpenRomLink(),this.setUpBlur()}setUpFileDrop(){if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))return;n.a.handleFileDrop(this.root,(t,e,s)=>this.createAppFromFiles(t,e,s));const t=document.getElementById("drop-desc");t&&(t.style.display="")}createAppFromFiles(t,e,s){for(let i=0;i<t.length;++i){const r=t[i];if("js"!==p.a.getExt(r.name).toLowerCase())continue;const n=new a.a(this.wndMgr,{title:r.name,centerX:e,centerY:s,onClosed:t=>{this.removeApp(t)}});n.setFile(r),this.apps.push(n)}const i=["nes"],r=new Array;for(let e=0;e<t.length;++e){const s=t[e];let a=null;const o=p.a.getExt(s.name).toLowerCase();"js"===o||(a="zip"===o?n.a.loadFile(s).then(t=>{return(new C).loadAsync(t)}).then(t=>{for(let e of Object.keys(t.files)){const s=p.a.getExt(e).toLowerCase();if(i.indexOf(s)>=0)return t.files[e].async("uint8array").then(t=>Promise.resolve({type:s,binary:t,fileName:e}))}return Promise.reject(`No.nes file included:${s.name}`)}):i.indexOf(o)>=0?n.a.loadFile(s).then(t=>Promise.resolve({type:o,binary:t,fileName:s.name})):Promise.reject(`Unsupported file:${s.name}`)),a&&r.push(a)}Promise.all(r).catch(t=>{this.wndMgr.showSnackbar(t.toString())}).then(t=>{const i={};t.forEach(t=>{i[t.type]||(i[t.type]=[]),i[t.type].push(t)}),i.nes&&i.nes.forEach(t=>{this.createAppFromRom(t.binary,t.fileName,e,s),e+=16,s+=16})})}createAppFromRom(t,e,s,r){const n=e.match(/^(.*?)\s*\(.*\)\.\w*$/),a={title:n?n[1]:e,centerX:s,centerY:r,onClosed:t=>{this.removeApp(t)}},o=new i.a(this.wndMgr,a),h=o.loadRom(t);if(!0!==h)return this.wndMgr.showSnackbar(`${e}:${h}`),void o.close();o.setVolume(this.volume),this.apps.push(o)}removeApp(t){const e=this.apps.indexOf(t);e>=0&&this.apps.splice(e,1)}setUpPaletLink(){const t=document.getElementById("palet");null!=t&&t.addEventListener("click",()=>{null==this.globalPaletWnd?(this.globalPaletWnd=new r.b(this.wndMgr,()=>{this.globalPaletWnd=null}),this.wndMgr.add(this.globalPaletWnd)):this.wndMgr.moveToTop(this.globalPaletWnd)})}setUpGamePadLink(){const t=document.getElementById("gamepad");null!=t&&(l.isSupported()?t.addEventListener("click",()=>{null==this.gamepadWnd?(this.gamepadWnd=new d(this.wndMgr,()=>{this.gamepadWnd=null}),this.wndMgr.add(this.gamepadWnd)):this.wndMgr.moveToTop(this.gamepadWnd)}):t.style.display="none")}setUpVolumeLink(){const t=document.getElementById("volume"),e=document.getElementById("volume-slider-container"),s=document.getElementById("volume-slider");if(null==t||null==e||null==s)return;let i=!1,r=!1,a=-1;e.addEventListener("mousedown",t=>{if(0!==t.button)return;i=!0;const e=s.parentNode.getBoundingClientRect().height,a=t=>{const[,i]=n.a.getMousePosIn(t,s.parentNode),r=p.a.clamp(e-i,0,e);s.style.height=`${r}px`,this.volume=r/e,this.apps.forEach(t=>{t.setVolume(this.volume)})};n.a.setMouseDragListener({move:a,up:t=>{i=!1,r&&c(),this.volume=Math.round(100*this.volume)/100,o.a.put(y,this.volume)}}),a(t)});const h=()=>{const i=t.getBoundingClientRect(),r=parseInt(e.style.width||"0",10),a=parseInt(e.style.height||"0",10);n.a.setStyles(e,{display:"inherit",top:`${Math.round(i.y-a)}px`,left:`${Math.round(i.x+(i.width-r)/2)}px`});const o=s.parentNode.getBoundingClientRect().height;s.style.height=`${this.volume*o}px`,t.classList.add("active")},c=()=>{n.a.setStyles(e,{display:"none"}),t.classList.remove("active")};t.addEventListener("mouseenter",()=>{h()}),t.addEventListener("mouseleave",()=>{a=window.setTimeout(()=>{c()},10)}),e.addEventListener("mouseenter",t=>{r=!1,-1!==a&&(clearTimeout(a),a=-1)}),e.addEventListener("mouseleave",t=>{r=!0,i||c()})}setUpOpenRomLink(){const t=document.getElementById("rom-file");t.addEventListener("click",()=>{var path=t.value;var req=new XMLHttpRequest();req.open('GET',path,true);req.overrideMimeType('text/plain; charset=x-user-defined');req.responseType='arraybuffer';var target=this;req.onerror=()=>console.log(`Error loading ${path}:${req.statusText}`);req.onload=function(){if(this.status===200){var srom=this.response;if(srom){var byteArray=new Uint8Array(srom);target.createAppFromRom(byteArray,'test',0,0)}}else if(this.status===0){}else{req.onerror()}};req.send()})}setUpBlur(){window.addEventListener("blur",()=>{this.apps.forEach(t=>{t.onBlur()})}),window.addEventListener("focus",()=>{this.apps.forEach(t=>{t.onFocus()})})}}window.addEventListener("load",()=>{o.a.setKeyPrefix("nesemu:"),l.setUp();const t=document.getElementById("nesroot");null!=t&&new B(t)})},11:function(t,e,s){"use strict";s.d(e,"a",function(){return r}),s.d(e,"b",function(){return n});const i=[[234,1,1,1,2],[169,2,3,2,2],[165,2,5,2,3],[181,2,6,2,4],[173,2,8,3,4],[189,2,9,3,4],[185,2,10,3,4],[161,2,12,2,6],[177,2,13,2,5],[133,3,5,2,3],[149,3,6,2,4],[141,3,8,3,4],[157,3,9,3,5],[153,3,10,3,5],[149,3,6,2,4],[129,3,12,2,6],[145,3,13,2,6],[162,4,3,2,2],[166,4,5,2,3],[182,4,7,2,4],[174,4,8,3,4],[190,4,10,3,4],[134,5,5,2,3],[150,5,7,2,4],[142,5,8,3,4],[160,6,3,2,2],[164,6,5,2,3],[180,6,6,2,4],[172,6,8,3,4],[188,6,9,3,4],[132,7,5,2,3],[148,7,6,2,4],[140,7,8,3,4],[170,8,1,1,2],[168,9,1,1,2],[138,10,1,1,2],[152,11,1,1,2],[154,12,1,1,2],[186,13,1,1,2],[105,14,3,2,2],[101,14,5,2,3],[117,14,6,2,4],[109,14,8,3,4],[125,14,9,3,4],[121,14,10,3,4],[97,14,12,2,6],[113,14,13,2,5],[233,15,3,2,2],[229,15,5,2,3],[245,15,6,2,4],[237,15,8,3,4],[253,15,9,3,4],[249,15,10,3,4],[225,15,12,2,6],[241,15,13,2,5],[201,30,3,2,2],[197,30,5,2,3],[213,30,6,2,4],[205,30,8,3,4],[221,30,9,3,4],[217,30,10,3,4],[193,30,12,2,6],[209,30,13,2,5],[224,31,3,2,2],[228,31,5,2,3],[236,31,8,3,4],[192,32,3,2,2],[196,32,5,2,3],[204,32,8,3,4],[232,16,1,1,2],[200,17,1,1,2],[230,18,5,2,5],[246,18,6,2,6],[238,18,8,3,6],[254,18,9,3,7],[202,19,1,1,2],[136,20,1,1,2],[198,21,5,2,5],[214,21,6,2,6],[206,21,8,3,6],[222,21,9,3,7],[41,22,3,2,2],[37,22,5,2,3],[53,22,6,2,4],[45,22,8,3,4],[61,22,9,3,4],[57,22,10,3,4],[33,22,12,2,6],[49,22,13,2,5],[9,23,3,2,2],[5,23,5,2,3],[21,23,6,2,4],[13,23,8,3,4],[29,23,9,3,4],[25,23,10,3,4],[1,23,12,2,6],[17,23,13,2,5],[73,24,3,2,2],[69,24,5,2,3],[85,24,6,2,4],[77,24,8,3,4],[93,24,9,3,4],[89,24,10,3,4],[65,24,12,2,6],[81,24,13,2,5],[42,25,2,1,2],[38,25,5,2,5],[54,25,6,2,6],[46,25,8,3,6],[62,25,9,3,7],[106,26,2,1,2],[102,26,5,2,5],[118,26,6,2,6],[110,26,8,3,6],[126,26,9,3,7],[10,27,2,1,2],[6,27,5,2,5],[22,27,6,2,6],[14,27,8,3,6],[30,27,9,3,7],[74,28,2,1,2],[70,28,5,2,5],[86,28,6,2,6],[78,28,8,3,6],[94,28,9,3,7],[36,29,5,2,3],[44,29,8,3,4],[76,33,8,3,3],[108,33,11,3,5],[32,34,8,3,6],[96,35,1,1,6],[64,36,1,1,6],[144,37,14,2,2],[176,38,14,2,2],[16,39,14,2,2],[48,40,14,2,2],[208,41,14,2,2],[240,42,14,2,2],[80,43,14,2,2],[112,44,14,2,2],[72,45,1,1,3],[8,46,1,1,3],[104,47,1,1,4],[40,48,1,1,4],[24,49,1,1,2],[56,50,1,1,2],[120,51,1,1,2],[88,52,1,1,2],[184,53,1,1,2],[248,54,1,1,2],[216,55,1,1,2],[0,56,1,1,7]],r={opType:0,addressing:0,bytes:1,cycle:0},n=(()=>{const t=new Array(256);return t.fill(r),i.forEach(e=>{const[s,i,r,n,a]=e;t[s]={opType:i,addressing:r,bytes:n,cycle:a}}),t})()},12:function(t,e,s){"use strict";s.d(e,"a",function(){return o}),s.d(e,"d",function(){return h}),s.d(e,"c",function(){return c}),s.d(e,"e",function(){return l}),s.d(e,"b",function(){return u});var i=s(4),r=s(1),n=s(2),a=s(35);class o extends i.a{constructor(t,e){super(t,80,48,"Fps"),this.stream=e;const s=document.createElement("div");r.a.setStyles(s,{width:"80px",height:"48px"}),this.setContent(s),this.stats=new a,this.stats.domElement.style.position="",s.appendChild(this.stats.domElement),this.subscription=this.stream.subscribe(t=>{switch(t){case 7:this.stats.begin();break;case 8:this.stats.end()}})}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}}class h extends i.a{constructor(t,e,s){super(t,h.W*h.UNIT,h.H*h.UNIT,"Palette"),this.nes=e,this.stream=s,this.palet=new Uint8Array(h.W*h.H),this.tmp=new Uint8Array(h.W*h.H),this.selected=new Uint8Array(h.H);const{root:i,boxes:r,groups:n}=this.createDom();this.setContent(i),this.boxes=r,this.groups=n,this.selected.fill(0),this.subscription=this.stream.subscribe(t=>{switch(t){case 1:this.render()}}),this.palet.fill(-1),this.render()}getSelectedPalets(t){const e=this.selected;for(let s=0;s<e.length;++s)t[s]=e[s]}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}render(){const t=this.tmp;this.getPalet(t);const e=this.nes.getPaletColorTable(),s=h.W*h.H;for(let i=0;i<s;++i){const s=t[i];if(s===this.palet[i])continue;this.palet[i]=s;const r=3*s,n=e[r+0],a=e[r+1],o=e[r+2];this.boxes[i].style.backgroundColor=`rgb(${n},${a},${o})`}}getPalet(t){const e=this.nes.getPpu(),s=h.W*h.H;for(let i=0;i<s;++i)t[i]=e.getPalet(i)}createDom(){const t=h.UNIT,e=h.W,s=h.H,i=document.createElement("div");i.className="clearfix",r.a.setStyles(i,{width:`${t*e}px`,height:`${t*s}px`});const n=new Array(e*s),a=new Array(e/4*s);for(let o=0;o<s;++o){const s=document.createElement("div");s.className="pull-left clearfix",r.a.setStyles(s,{width:`${t*e}px`,height:`${t}px`,backgroundColor:"black"}),i.appendChild(s);for(let i=0;i<e/4;++i){const h=document.createElement("div");h.className="pull-left clearfix",r.a.setStyles(h,{width:`${4*t}px`,height:`${t}px`,cursor:"pointer"}),a[i+o*(e/4)]=h,s.appendChild(h),h.addEventListener("click",t=>{this.select(o,i)});for(let s=0;s<4;++s){const a=document.createElement("div");a.className="pull-left",r.a.setStyles(a,{width:`${t-1}px`,height:`${t-1}px`,marginRight:"1px"}),n[4*i+s+o*e]=a,h.appendChild(a)}}}return{root:i,boxes:n,groups:a}}select(t,e){this.groups[t*(h.W/4)+this.selected[t]].style.backgroundColor="",this.groups[t*(h.W/4)+e].style.backgroundColor="red",this.selected[t]=e}}h.UNIT=8,h.W=16,h.H=2;class c extends i.a{constructor(t,e,s,i){const n=256*(i?1:2),a=240*(i?2:1);super(t,n,a,"NameTable"),this.nes=e,this.stream=s,this.vert=i;const o=document.createElement("canvas");o.width=n,o.height=a,r.a.setStyles(o,{width:`${n}px`,height:`${a}px`}),o.className="pixelated",r.a.clearCanvas(o),this.setContent(o),this.canvas=o,this.context=r.a.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.subscription=this.stream.subscribe(t=>{switch(t){case 1:this.render()}}),this.render()}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}render(){const t=this.vert?0:256,e=this.vert?240:0;this.nes.renderNameTable1(this.imageData.data,this.imageData.width,0,0,0),this.nes.renderNameTable1(this.imageData.data,this.imageData.width,t,e,1),this.context.putImageData(this.imageData,0,0)}}class l extends i.a{constructor(t,e,s,i){super(t,256,128,"PatternTable"),this.nes=e,this.stream=s,this.getSelectedPalets=i,this.buf=new Uint8Array(2);const n=l.createCanvas();this.setContent(n),this.canvas=n,this.context=r.a.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.subscription=this.stream.subscribe(t=>{switch(t){case 1:this.render()}}),this.render()}static createCanvas(){const t=document.createElement("canvas");return t.width=256,t.height=128,r.a.setStyles(t,{width:"256px",height:"128px"}),t.className="pixelated",r.a.clearCanvas(t),t}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}render(){const t=this.buf;this.getSelectedPalets(t),this.nes.renderPatternTable(this.imageData.data,this.imageData.width,t),this.context.putImageData(this.imageData,0,0)}}class u extends i.a{constructor(t,e){super(t,u.W*u.UNIT,u.H*u.UNIT,"Global palette"),this.onClose=e;const{root:s,boxes:i}=this.createDom();this.setContent(s),this.boxes=i;const r=this.boxes.length;for(let t=0;t<r;++t){const e=n.a[3*t+0],s=n.a[3*t+1],i=n.a[3*t+2];this.boxes[t].style.backgroundColor=`rgb(${e},${s},${i})`}}close(){null!=this.onClose&&this.onClose(),super.close()}createDom(){const t=u.UNIT,e=u.W,s=u.H,i=document.createElement("div");i.className="clearfix",r.a.setStyles(i,{width:`${t*e}px`,height:`${t*s}px`});const n=new Array(e*s);for(let a=0;a<s;++a){const s=document.createElement("div");s.className="pull-left clearfix",r.a.setStyles(s,{width:`${t*e}px`,height:`${t}px`,backgroundColor:"black"}),i.appendChild(s);for(let i=0;i<e;++i){const o=document.createElement("div");o.className="pull-left",r.a.setStyles(o,{width:`${t-1}px`,height:`${t-1}px`,marginRight:"1px"}),n[i+a*e]=o,s.appendChild(o)}}return{root:i,boxes:n}}}u.UNIT=12,u.W=16,u.H=4},18:function(t,e,s){"use strict";var i,r=s(25);class n{constructor(){this.subscribers=new Array,this.anyRemoved=!1,this.nestCount=0}subscribe(t){return this.subscribers.push(t),{unsubscribe:()=>{const e=this.subscribers.indexOf(t);-1!==e&&(this.subscribers[e]=null,this.anyRemoved=!0)}}}next(t,e){++this.nestCount;for(let s of this.subscribers)null!=s&&s(t,e);--this.nestCount,0===this.nestCount&&this.anyRemoved&&(!function(t){let e=0;for(let s=0;s<t.length;++s)null!=t[s]&&(t[e++]=t[s]);t.length=e}(this.subscribers),this.anyRemoved=!1)}}(i||(i={})).Stream=class extends n{triggerRender(){this.next(1)}triggerRun(){this.next(2)}triggerPause(){this.next(3)}triggerStep(){this.next(4)}triggerReset(){this.next(5)}triggerBreakPoint(){this.next(6)}triggerStartCalc(){this.next(7)}triggerEndCalc(){this.next(8)}triggerOpenMenu(){this.next(9)}triggerCloseMenu(){this.next(10)}triggerCloseWnd(t){this.next(11,t)}};var a=s(24),o=s(4),h=s(1),c=s(11),l=s(23),u=s(0);class d extends o.a{constructor(t,e,s){super(t,100,160,"Regs"),this.nes=e,this.stream=s,this.valueElems=new Array;const i=this.createContent();this.setContent(i),this.subscription=this.stream.subscribe(t=>{switch(t){case 5:case 4:case 3:case 6:this.updateStatus()}})}static createPregStr(t){const e=new Array(8);for(let s=0;s<8;++s)e[s]=0!=(t&128>>s)?"NV_BDIZC"[s]:".";return e.join("")}updateStatus(){const t=this.nes.getCpu().getRegs();this.valueElems[0].value=u.a.hex(t.pc,4),this.valueElems[1].value=u.a.hex(t.a,2),this.valueElems[2].value=u.a.hex(t.x,2),this.valueElems[3].value=u.a.hex(t.y,2),this.valueElems[4].value=u.a.hex(t.s,2),this.valueElems[5].value=d.createPregStr(t.p),this.valueElems[6].value=String(this.nes.getCycleCount())}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}createContent(){const t=document.createElement("div");t.className="fixed-font";const e=[{name:"PC"},{name:"A"},{name:"X"},{name:"Y"},{name:"S"},{name:"P"},{name:"cycle"}],s=document.createElement("table");h.a.setStyles(s,{fontSize:"10px",width:"100%"}),this.valueElems=[];for(let t=0;t<e.length;++t){const i=document.createElement("tr");s.appendChild(i);const r=document.createElement("td");r.innerText=e[t].name,i.appendChild(r);const n=document.createElement("td");i.appendChild(n);const a=document.createElement("input");a.className="fixed-font",a.type="text",a.style.width="100%",n.appendChild(a),this.valueElems.push(a)}return t.appendChild(s),t}}const p=3,g=100,m={opType:0,addressing:0,bytes:1,cycle:0};class f extends o.a{constructor(t,e,s){super(t,400,160,"Trace"),this.nes=e,this.stream=s,this.mem=new Uint8Array(p),this.bins=new Array(p),this.lines=new Array;const i=this.createContent();this.setContent(i),this.reset(),this.subscription=this.stream.subscribe(t=>{switch(t){case 5:this.reset();case 4:case 3:case 6:this.updateStatus()}})}reset(){this.lines=[]}updateStatus(){const t=this.nes.getCpu(),e=this.nes.getBus(),s=t.getRegs().pc,i=e.read8(s),r=c.b[i]||m;for(let t=0;t<r.bytes;++t){const i=e.read8(s+t);this.mem[t]=i,this.bins[t]=u.a.hex(i,2)}for(let t=r.bytes;t<p;++t)this.bins[t]="  ";const n=u.a.hex(s,4),a=this.bins.join(" "),o=Object(l.b)(r,this.mem,1,s);this.putConsole(`${n}:${a}${o}`)}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}createContent(){const t=document.createElement("div"),e=document.createElement("textarea");return e.className="fixed-font",h.a.setStyles(e,{fontSize:"14px",width:"100%",height:"160px",resize:"none",margin:"0",padding:"2px",border:"none",boxSizing:"border-box"}),t.appendChild(e),this.textarea=e,t}putConsole(t){this.lines.push(t),this.lines.length>g&&this.lines.shift(),this.textarea.value=this.lines.join("\n"),this.textarea.scrollTop=this.textarea.scrollHeight}}class b extends o.a{constructor(t,e){super(t,192,32,"Control"),this.stream=e;const s=this.createElement();this.setContent(s),this.updateState(!0),this.subscription=this.stream.subscribe(t=>{switch(t){case 2:this.updateState(!1);break;case 3:case 6:this.updateState(!0)}})}updateState(t){this.stepBtn.disabled=!t,this.runBtn.disabled=!t,this.pauseBtn.disabled=t}close(){this.stream.triggerCloseWnd(this),this.subscription.unsubscribe(),super.close()}createElement(){const t=document.createElement("div");h.a.setStyles(t,{width:"256px",height:"32px"}),this.stepBtn=document.createElement("button"),this.stepBtn.innerText="Step",this.stepBtn.addEventListener("click",()=>{this.stream.triggerStep()}),t.appendChild(this.stepBtn),this.runBtn=document.createElement("button"),this.runBtn.innerText="Run",this.runBtn.addEventListener("click",()=>{this.stream.triggerRun()}),t.appendChild(this.runBtn),this.pauseBtn=document.createElement("button"),this.pauseBtn.innerText="Pause",this.pauseBtn.addEventListener("click",()=>{this.stream.triggerPause()}),t.appendChild(this.pauseBtn);const e=document.createElement("button");return e.innerText="Reset",e.addEventListener("click",()=>{this.stream.triggerReset()}),t.appendChild(e),t}}var k=s(12),w=s(26),C=s(6);s.d(e,"b",function(){return v}),s.d(e,"a",function(){return M});const y=1789773,B=1e3/15,v=.125;class M{constructor(t,e,s){if(this.wndMgr=t,this.option=e,this.destroying=!1,this.isBlur=!1,this.stream=new i.Stream,this.wndMap={},this.volume=1,s)return;this.nes=r.a.create(),window.app=this,this.nes.setVblankCallback(t=>{this.onVblank(t)}),this.nes.setBreakPointCallback(()=>{this.onBreakPoint()}),this.subscription=this.stream.subscribe((t,e)=>this.handleAppEvent(t,e));const n=new w.a(this.wndMgr,this,this.nes,this.stream);this.wndMap[1]=this.screenWnd=n,this.wndMgr.add(this.screenWnd),this.title=e.title||"NES",this.screenWnd.setTitle(this.title);const a=this.screenWnd.getWindowSize();let o=u.a.clamp((e.centerX||0)-a.width/2,0,window.innerWidth-a.width-1),h=u.a.clamp((e.centerY||0)-a.height/2,0,window.innerHeight-a.height-1);this.screenWnd.setPos(o,h)}static create(t,e){return new M(t,e)}handleAppEvent(t,e){switch(t){case 1:break;case 2:this.nes.getCpu().pause(!1);break;case 3:this.nes.getCpu().pause(!0),this.muteAudio();break;case 4:this.nes.step(0);break;case 5:this.nes.reset();break;case 9:this.cancelLoopAnimation(),this.muteAudio();break;case 10:this.startLoopAnimation();break;case 11:{const t=e,s=Object.keys(this.wndMap).find(e=>this.wndMap[e]===t);null!=s&&(delete this.wndMap[s],1===parseInt(s,10)&&this.destroy())}}}setVolume(t){this.volume=t,this.audioManager.setMasterVolume(this.volume*v)}loadRom(t){const e=this.nes.setRomData(t);if(!0!==e)return e;const s=window.AudioContext||window.webkitAudioContext;return this.audioManager=new a.a(s),this.setupAudioManager(),this.nes.reset(),this.nes.getCpu().pause(!1),this.screenWnd.getContentHolder().focus(),this.startLoopAnimation(),window.$DEBUG&&(this.createPaletWnd(),this.createNameTableWnd(),this.createPatternTableWnd(),this.createTraceWnd(),this.createRegisterWnd(),this.createControlWnd()),!0}close(){this.screenWnd.close()}saveData(){const t=this.nes.save();return C.a.putObject(this.title,t)}hasSaveData(){return C.a.hasKey(this.title)}loadData(){const t=C.a.getObject(this.title,null);if(t)try{this.nes.load(t)}catch(t){console.error(t),this.wndMgr.showSnackbar("Error: Load data failed"),this.nes.reset()}else this.wndMgr.showSnackbar(`No save data for"${this.title}"`)}onBlur(){this.isBlur||(this.isBlur=!0,this.audioManager&&this.audioManager.setMasterVolume(0))}onFocus(){this.isBlur&&(this.isBlur=!1,this.audioManager&&this.audioManager.setMasterVolume(this.volume*v))}createPaletWnd(){if(null!=this.wndMap[2])return!1;const t=new k.d(this.wndMgr,this.nes,this.stream);return this.wndMgr.add(t),t.setPos(520,0),this.wndMap[2]=t,!0}createNameTableWnd(){if(null!=this.wndMap[3])return!1;const t=new k.c(this.wndMgr,this.nes,this.stream,0===this.nes.getPpu().getMirrorMode());return this.wndMgr.add(t),t.setPos(520,40),this.wndMap[3]=t,!0}createPatternTableWnd(){if(null!=this.wndMap[4])return!1;const t=new k.e(this.wndMgr,this.nes,this.stream,t=>{const e=this.wndMap[2];return null!=e&&(e.getSelectedPalets(t),!0)});return this.wndMgr.add(t),t.setPos(520,300),this.wndMap[4]=t,!0}createTraceWnd(){if(null!=this.wndMap[6])return!1;const t=new f(this.wndMgr,this.nes,this.stream);return this.wndMgr.add(t),t.setPos(0,500),this.wndMap[6]=t,!0}createRegisterWnd(){if(null!=this.wndMap[5])return!1;const t=new d(this.wndMgr,this.nes,this.stream);return this.wndMgr.add(t),t.setPos(410,500),this.wndMap[5]=t,!0}createControlWnd(){if(null!=this.wndMap[7])return!1;const t=new b(this.wndMgr,this.stream);return this.wndMgr.add(t),t.setPos(520,500),this.wndMap[7]=t,!0}createFpsWnd(){if(null!=this.wndMap[8])return!1;const t=new k.a(this.wndMgr,this.stream);return this.wndMgr.add(t),this.wndMap[8]=t,!0}destroy(){for(let t of Object.values(this.wndMap))t.close();this.cleanUp(),this.option.onClosed&&this.option.onClosed(this)}cleanUp(){this.cancelLoopAnimation(),this.destroying=!0,this.audioManager&&this.audioManager.release(),this.subscription.unsubscribe()}onVblank(t){t<1&&this.render(),this.updateAudio()}onBreakPoint(){this.stream.triggerBreakPoint()}startLoopAnimation(){if(null!=this.rafId)return;let t=window.performance.now();const e=()=>{if(this.destroying)return;this.stream.triggerStartCalc();const s=window.performance.now(),i=s-t;t=s,this.update(i),this.stream.triggerEndCalc(),this.rafId=requestAnimationFrame(e)};this.rafId=requestAnimationFrame(e)}cancelLoopAnimation(){null!=this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0)}update(t){if(this.nes.getCpu().isPaused())return;for(let t=0;t<2;++t){const e=this.wndMgr.getPadStatus(this.screenWnd,t);this.nes.setPadStatus(t,e)}let e=Math.min(t,B);e=this.wndMgr.getKeyPressing(this.screenWnd,16)?4*e:e;const s=y*e/1e3|0;this.nes.runCycles(s)}render(){this.stream.triggerRender()}updateAudio(){const t=this.audioManager,e=t.getChannelCount();for(let s=0;s<e;++s){const e=this.nes.getSoundVolume(s);t.setChannelVolume(s,e),e>0&&(t.setChannelFrequency(s,this.nes.getSoundFrequency(s)),t.setChannelDutyRatio(s,this.nes.getSoundDutyRatio(s)))}}muteAudio(){const t=this.audioManager.getChannelCount();for(let e=0;e<t;++e)this.audioManager.setChannelVolume(e,0)}setupAudioManager(){this.audioManager.release(),this.audioManager.setMasterVolume(this.volume*v);const t=this.nes.getSoundChannelTypes();for(const e of t)this.audioManager.addChannel(e)}}},2:function(t,e,s){"use strict";s.d(e,"a",function(){return i}),s.d(e,"c",function(){return r}),s.d(e,"b",function(){return n});const i=Uint8Array.from([124,124,124,0,0,252,0,0,188,68,40,188,148,0,132,168,0,32,168,16,0,136,20,0,80,48,0,0,120,0,0,104,0,0,88,0,0,64,88,0,0,0,0,0,0,0,0,0,188,188,188,0,120,248,0,88,248,104,68,252,216,0,204,228,0,88,248,56,0,228,92,16,172,124,0,0,184,0,0,168,0,0,168,68,0,136,136,0,0,0,0,0,0,0,0,0,248,248,248,60,188,252,104,136,252,152,120,248,248,120,248,248,88,152,248,120,88,252,160,68,248,184,0,184,248,24,88,216,84,88,248,152,0,232,216,120,120,120,0,0,0,0,0,0,252,252,252,164,228,252,184,184,248,216,184,248,248,184,248,248,164,192,240,208,176,252,224,168,248,216,120,216,248,120,184,248,184,184,248,216,0,252,252,248,216,248,0,0,0,0,0,0]),r=(()=>{const t=new Uint16Array(256);for(let e=0;e<256;++e){let s=0;for(let t=0;t<8;++t)s<<=2,0!=(e&1<<7-t)&&(s|=1);t[e]=s}return t})(),n=(()=>{const t=new Uint8Array(256);for(let e=0;e<256;++e){let s=0;for(let t=0;t<8;++t)s<<=1,0!=(e&1<<t)&&(s|=1);t[e]=s}return t})()},23:function(t,e,s){"use strict";s.d(e,"b",function(){return a}),s.d(e,"a",function(){return c});var i=s(11),r=s(0);const n={2:"LDA",3:"STA",4:"LDX",5:"STX",6:"LDY",7:"STY",8:"TAX",9:"TAY",10:"TXA",11:"TYA",12:"TXS",13:"TSX",14:"ADC",15:"SBC",16:"INX",17:"INY",18:"INC",19:"DEX",20:"DEY",21:"DEC",22:"AND",23:"ORA",24:"EOR",25:"ROL",26:"ROR",27:"ASL",28:"LSR",29:"BIT",30:"CMP",31:"CPX",32:"CPY",33:"JMP",34:"JSR",35:"RTS",36:"RTI",37:"BCC",38:"BCS",39:"BPL",40:"BMI",41:"BNE",42:"BEQ",43:"BVC",44:"BVS",45:"PHA",46:"PHP",47:"PLA",48:"PLP",49:"CLC",50:"SEC",51:"SEI",52:"CLI",53:"CLV",54:"SED",55:"CLD",56:"BRK",1:"NOP"};function a(t,e,s,i){let a="";switch(t.addressing){case 1:case 2:break;case 3:a=`#$${r.a.hex(e[s],2)}`;break;case 4:a=`#$${r.a.hex(e[s]|e[s+1]<<8,4)}`;break;case 5:a=`$${r.a.hex(e[s],2)}`;break;case 6:a=`$${r.a.hex(e[s],2)},X`;break;case 7:a=`$${r.a.hex(e[s],2)},Y`;break;case 8:a=`$${r.a.hex(e[s]|e[s+1]<<8,4)}`;break;case 9:a=`$${r.a.hex(e[s]|e[s+1]<<8,4)},X`;break;case 10:a=`$${r.a.hex(e[s]|e[s+1]<<8,4)},Y`;break;case 11:a=`($${r.a.hex(e[s]|e[s+1]<<8,4)})`;break;case 12:a=`($${r.a.hex(e[s],2)},X)`;break;case 13:a=`($${r.a.hex(e[s],2)}),Y`;break;case 14:{const n=e[s];a=n<128?`+${n};$${r.a.hex(i+t.bytes+n,4)}`:`${n-256};$${r.a.hex(i+t.bytes+n-256,4)}`}break;default:console.error(`Unhandled addressing:${t.addressing}`)}return`${n[t.opType]}${a}`}const o=new Uint8Array(3),h=new Array(3);function c(t,e){const s=t.read8(e),n=i.b[s]||i.a;for(let s=0;s<n.bytes;++s){const i=t.read8(e+s);o[s]=i,h[s]=r.a.hex(i,2)}for(let t=n.bytes;t<3;++t)h[t]="  ";return`${r.a.hex(e,4)}:${h.join(" ")}${a(n,o,1,e)}`}},24:function(t,e,s){"use strict";s.d(e,"a",function(){return c});class i{destroy(){null!=this.gainNode&&this.gainNode.disconnect()}constructor(t){this.gainNode=t.createGain(),this.gainNode.gain.setValueAtTime(0,t.currentTime)}start(){}setVolume(t,e){this.gainNode.gain.setValueAtTime(t,e.currentTime)}setFrequency(t){}setDutyRatio(t){}}class r extends i{destroy(){super.destroy(),null!=this.oscillator&&this.oscillator.disconnect()}constructor(t){super(t),this.oscillator=t.createOscillator(),this.setupOscillator(this.oscillator,t)}start(){this.oscillator.start()}setFrequency(t){const e=this.gainNode.context.currentTime;this.oscillator.frequency.setValueAtTime(t,e)}}class n extends r{setupOscillator(t,e){t.type="triangle",t.connect(this.gainNode),this.gainNode.connect(e.destination)}}class a extends r{setupOscillator(t,e){t.type="sawtooth",t.connect(this.gainNode),this.gainNode.connect(e.destination)}}class o extends r{setupOscillator(t,e){const s=new Float32Array(1024),i=new Float32Array(1024);s[0]=i[0]=0;for(let t=1;t<1024;++t){const e=Math.random()*(2*Math.PI);s[t]=Math.cos(e),i[t]=Math.sin(e)}const r=e.createPeriodicWave(s,i);t.setPeriodicWave(r),t.connect(this.gainNode),this.gainNode.connect(e.destination)}}class h extends r{constructor(){super(...arguments),this.frequency=1,this.duty=.5}destroy(){super.destroy(),null!=this.delay&&this.delay.disconnect()}setFrequency(t){this.frequency!==t&&(this.frequency=t,super.setFrequency(t),this.updateDelay())}setDutyRatio(t){this.duty!==t&&(this.duty=t,this.updateDelay())}setupOscillator(t,e){t.type="sawtooth";const s=e.createGain();s.gain.value=-1,t.connect(s),s.connect(this.gainNode);const i=e.createDelay();t.connect(i),i.connect(this.gainNode),this.delay=i,this.gainNode.connect(e.destination)}updateDelay(){const t=this.delay.context.currentTime;this.delay.delayTime.setValueAtTime((1-this.duty)/this.frequency,t)}}class c{constructor(t){this.channels=new Array,this.masterVolume=0,c.setUp(t),this.masterVolume=1}static setUp(t){c.initialized||(c.initialized=!0,null!=t&&(c.context=new t))}addChannel(t){const e=c.context;if(null==e)return;const s=function(t,e){switch(e){case 0:return new h(t);case 1:return new n(t);case 3:return new o(t);case 2:return new a(t)}}(e,t);s.start(),this.channels.push(s)}getChannelCount(){return this.channels.length}release(){if(null!=this.channels){for(let t of this.channels)t.destroy();this.channels.length=0}}setChannelFrequency(t,e){null!=c.context&&this.channels[t].setFrequency(e)}setChannelVolume(t,e){null!=c.context&&this.channels[t].setVolume(e*this.masterVolume,c.context)}setChannelDutyRatio(t,e){null!=c.context&&this.channels[t].setDutyRatio(e)}setMasterVolume(t){const e=c.context;null!=e&&(this.masterVolume=t,t<=0&&this.channels.forEach(t=>{t.setVolume(0,e)}))}}c.initialized=!1},25:function(t,e,s){"use strict";var i=s(0);const r=16384,n=21,a=22,o=23,h=23,c=64,l=128,u=16,d=32,p=128,g=32,m=1789773,f=4,b=0,k=1,w=2,C=3,y=0,B=1,v=2,M=3,x=[0,0,1,3],E=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],S=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],P=[.125,.25,.5,-.25],T=241;class q{constructor(){this.status=new Uint8Array(2),this.tmp=new Uint8Array(2)}setStatus(t,e){192==(192&e)&&(e&=-193),48==(48&e)&&(e&=-49),this.status[t]=e}latch(){this.tmp[0]=this.status[0],this.tmp[1]=this.status[1]}shift(t){const e=this.tmp[t];return this.tmp[t]=e>>1,1&e}}class A{constructor(){this.regs=new Uint8Array(4),this.stopped=!0}reset(){this.regs.fill(0),this.stopped=!0}write(t,e){this.regs[t]=e}getVolume(){return 0}getFrequency(){return 0}getDutyRatio(){return.5}stop(){this.stopped=!0}update(){}isPlaying(){return!this.stopped}}class _ extends A{constructor(){super(...arguments),this.lengthCounter=0,this.sweepCounter=0,this.envelopeDivider=0,this.envelopeCounter=0,this.envelopeReset=!1}reset(){super.reset(),this.sweepCounter=0,this.envelopeDivider=this.envelopeCounter=0}write(t,e){switch(super.write(t,e),t){case y:this.stopped=!1,0==(e&u)&&(this.envelopeDivider=15&e,this.envelopeCounter=15);break;case B:this.sweepCounter=e>>4&7;break;case M:this.lengthCounter=E[e>>3],this.stopped=!1,this.envelopeReset=!0}}getVolume(){if(this.stopped)return 0;let t=this.regs[y];return 0!=(t&u)?(15&t)/15:this.envelopeCounter/15}getFrequency(){const t=this.regs[v]+((7&this.regs[M])<<8);return m/16/(t+1)|0}getDutyRatio(){return P[this.regs[y]>>6&3]}update(){this.stopped||(this.updateLength(),this.updateEnvelope(),this.sweep())}updateLength(){if(0!=(this.regs[y]&d))return;let t=this.lengthCounter;t<=0?(t=0,this.stopped=!0):(t-=4)<0&&(t=0),this.lengthCounter=t}updateEnvelope(){if(0!=(this.regs[y]&u))return;if(this.envelopeReset)return this.envelopeReset=!1,this.envelopeCounter=15,void(this.envelopeDivider=15&this.regs[y]);this.envelopeDivider>=2?this.envelopeDivider-=2:this.envelopeCounter>0?(--this.envelopeCounter,this.envelopeDivider+=15&this.regs[y]):(this.envelopeCounter=0,0!=(this.regs[y]&g)&&(this.envelopeCounter=15,this.envelopeDivider+=15&this.regs[y]))}sweep(){const t=this.regs[B];if(0==(128&t))return;let e=this.sweepCounter;const s=t>>4&7;if((e+=2)>=s){e-=s;let i=this.regs[v]+((7&this.regs[M])<<8);const r=7&t;if(r>0){const e=i>>r;0==(8&t)?(i+=e)>2047&&(this.stopped=!0):(i-=e)<8&&(this.stopped=!0),this.regs[v]=255&i,this.regs[M]=-8&this.regs[M]|(1792&i)>>8}(e-=2)<=0&&(this.sweepCounter=(t>>4&7)+e)}this.sweepCounter=e}}class R extends A{constructor(){super(...arguments),this.lengthCounter=0}write(t,e){switch(super.write(t,e),t){case y:case M:this.lengthCounter=127&this.regs[y],this.stopped=this.lengthCounter<=0}}getVolume(){return this.stopped?0:1}getFrequency(){const t=this.regs[v]+((7&this.regs[M])<<8);return m/32/(t+1)|0}update(){this.stopped||this.updateLength()}updateLength(){if(0!=(this.regs[y]&p))return;let t=this.lengthCounter;t<=0?(t=0,this.stopped=!0):(t-=4)<=0&&(t=0),this.lengthCounter=t}}class I extends A{constructor(){super(...arguments),this.lengthCounter=0}write(t,e){switch(super.write(t,e),t){case M:this.lengthCounter=E[e>>3],this.stopped=!1}}getVolume(){if(this.stopped)return 0;let t=this.regs[y];return 0!=(t&u)?(15&t)/15:1}getFrequency(){const t=15&this.regs[v];return S[t]}update(){this.stopped||this.updateLength()}updateLength(){if(0!=(this.regs[y]&d))return;let t=this.lengthCounter;t<=0?(t=0,0==(128&this.regs[2])&&(this.stopped=!0)):(t-=1)<0&&(t=0),this.lengthCounter=t}}class D{constructor(t){this.triggerIrq=t,this.regs=new Uint8Array(32),this.channels=new Array(f),this.frameInterrupt=0,this.dmcInterrupt=128,this.gamePad=new q,this.channels[b]=new _,this.channels[k]=new _,this.channels[w]=new R,this.channels[C]=new I}getChannelTypes(){return x}reset(){this.regs.fill(0),this.regs[h]=c,this.frameInterrupt=0,this.dmcInterrupt=128,this.channels.forEach(t=>{t.reset()})}save(){return{regs:i.a.convertUint8ArrayToBase64String(this.regs)}}load(t){this.regs=i.a.convertBase64StringToUint8Array(t.regs)}read(t){const e=t-r;switch(e){case n:{let t=this.dmcInterrupt|this.frameInterrupt;for(let e=0;e<f;++e)this.channels[e].isPlaying()&&(t|=1<<e);return this.frameInterrupt=0,t}case a:case o:return this.gamePad.shift(e-a);default:return 0}}write(t,e){const s=t-r;if(!(s>=32)){if(this.regs[s]=e,s<16){const t=s>>2,i=3&s;this.channels[t].write(i,e)}switch(s){case n:this.dmcInterrupt=0;for(let t=0;t<f;++t)0==(e&1<<t)&&this.channels[t].stop();break;case a:0==(1&e)&&this.gamePad.latch()}}}getVolume(t){return 0==(this.regs[n]&1<<t)?0:this.channels[t].getVolume()}getFrequency(t){return this.channels[t].getFrequency()}getDutyRatio(t){return this.channels[t].getDutyRatio()}setPadStatus(t,e){this.gamePad.setStatus(t,e)}onHblank(t){switch(t){case T:this.channels.forEach(t=>{t.update()}),this.isIrqEnabled()&&(this.frameInterrupt=64,this.triggerIrq())}}isIrqEnabled(){return 0==(this.regs[h]&(c|l))}}const H=8192;class L{constructor(){this.readerFuncTable=new Array(65536/H),this.writerFuncTable=new Array(65536/H),this.readErrorReported=!1,this.writeErrorReported=!1,this.clearMemoryMap()}clearMemoryMap(){this.readerFuncTable.fill(t=>255),this.writerFuncTable.fill((t,e)=>{})}setReadMemory(t,e,s){const i=e/H|0;for(let e=t/H|0;e<=i;++e)this.readerFuncTable[e]=s}setWriteMemory(t,e,s){const i=e/H|0;for(let e=t/H|0;e<=i;++e)this.writerFuncTable[e]=s}read8(t){const e=t/H|0,s=this.readerFuncTable[e];return s?s(t):(this.readErrorReported||(console.error(`Illegal read at ${i.a.hex(t,4)}`),this.readErrorReported=!0),191)}write8(t,e){const s=t/H|0,r=this.writerFuncTable[s];if(r)return r(t,e);if(!this.writeErrorReported){const s=i.a.hex(t,4),r=i.a.hex(e,2);console.error(`Illegal write at ${s},${r}`),this.writeErrorReported=!0}}dump(t,e){const s=new Array;for(let i=0;i<e;++i)s.push(this.read8(i+t));for(let r=0;r<e;r+=16){const e=s.splice(0,16).map(t=>i.a.hex(t,2)).join(" ");console.log(`${i.a.hex(t+r,4)}:${e}`)}}}var W=s(11),N=s(23);const U=0,F=1,O=2,$=3,V=4,z=6,j=7,K=1<<V,G=32,Z=65530,X=65532,Y=65534,J=200;function Q(t){return t+1&255}function tt(t){return t-1&255}class et{constructor(t){this.bus=t,this.negative=0,this.overflow=0,this.breakmode=0,this.decimal=0,this.irqBlocked=0,this.zero=0,this.carry=0,this.breakPoints={},this.watchRead={},this.watchWrite={},this.paused=!1,this.irqDetected=!1,this.stepLogs=[],this.$DEBUG="undefined"!=typeof window&&!!window.$DEBUG,this.a=this.x=this.y=this.s=0,this.pc=0}reset(){this.s=this.s-3&255,this.pc=this.read16(X),this.negative=this.overflow=this.decimal=this.zero=this.carry=0,this.irqBlocked=this.breakmode=1,this.stepLogs.length=0}getRegs(){return{a:this.a,x:this.x,y:this.y,s:this.s,p:this.getStatusReg(),pc:this.pc}}save(){return this.getRegs()}load(t){this.a=t.a,this.x=t.x,this.y=t.y,this.s=t.s,this.pc=t.pc,this.setStatusReg(t.p)}deleteAllBreakPoints(){this.breakPoints={},this.watchRead={},this.watchWrite={}}pause(t){this.paused=t}isPaused(){return this.paused}nmi(){const t=this.read16(Z);this.breakPoints.nmi&&(this.paused=!0,console.warn(`paused because NMI:${i.a.hex(this.pc,4)},${i.a.hex(t,4)}`)),this.$DEBUG&&this.addStepLog(`NMI occurred at pc=${i.a.hex(this.pc,4)}`),this.push16(this.pc),this.push(this.getStatusReg()&~K),this.pc=t,this.irqBlocked=1}requestIrq(){this.irqDetected=!0}step(){this.irqDetected&&0===this.irqBlocked&&(this.irqDetected=!1,this.handleIrq());let t=this.pc;this.$DEBUG&&this.addStepLog(Object(N.a)(this.bus,t));const e=this.read8(t++),s=W.b[e];if(null==s)return console.error(`Unhandled OPCODE,${i.a.hex(this.pc-1,4)}:${i.a.hex(e,2)}`),this.paused=!0,0;this.pc+=s.bytes;const r=this.getAdr(t,s.addressing);let n=s.cycle;switch(s.opType){default:case 0:case 1:break;case 2:this.a=this.read8(r),this.setNZFlag(this.a);break;case 3:this.write8(r,this.a);break;case 4:this.x=this.read8(r),this.setNZFlag(this.x);break;case 5:this.write8(r,this.x);break;case 6:this.y=this.read8(r),this.setNZFlag(this.y);break;case 7:this.write8(r,this.y);break;case 8:this.x=this.a,this.setNZFlag(this.x);break;case 9:this.y=this.a,this.setNZFlag(this.y);break;case 10:this.a=this.x,this.setNZFlag(this.a);break;case 11:this.a=this.y,this.setNZFlag(this.a);break;case 12:this.s=this.x;break;case 13:this.x=this.s,this.setNZFlag(this.x);break;case 14:{const t=this.carry,e=this.read8(r),s=this.a+e+t,i=0!=((this.a^s)&(e^s)&128);this.a=255&s,this.setNZCFlag(this.a,s>=256),this.setOverFlow(i)}break;case 15:{const t=this.carry,e=255-this.read8(r),s=this.a+e+t,i=0!=((this.a^s)&(e^s)&128);this.a=255&s,this.setNZCFlag(this.a,s>=256),this.setOverFlow(i)}break;case 16:this.x=Q(this.x),this.setNZFlag(this.x);break;case 17:this.y=Q(this.y),this.setNZFlag(this.y);break;case 18:{const t=Q(this.read8(r));this.write8(r,t),this.setNZFlag(t)}break;case 19:this.x=tt(this.x),this.setNZFlag(this.x);break;case 20:this.y=tt(this.y),this.setNZFlag(this.y);break;case 21:{const t=tt(this.read8(r));this.write8(r,t),this.setNZFlag(t)}break;case 22:{const t=this.read8(r);this.a&=t,this.setNZFlag(this.a)}break;case 23:{const t=this.read8(r);this.a|=t,this.setNZFlag(this.a)}break;case 24:{const t=this.read8(r);this.a^=t,this.setNZFlag(this.a)}break;case 25:{const t=2===s.addressing,e=t?this.a:this.read8(r),i=e>=128,n=255&(e<<1|this.carry);t?this.a=n:this.write8(r,n),this.setNZCFlag(n,i)}break;case 26:{const t=2===s.addressing,e=t?this.a:this.read8(r),i=0!=(1&e),n=e>>1|this.carry<<7;t?this.a=n:this.write8(r,n),this.setNZCFlag(n,i)}break;case 27:{const t=2===s.addressing,e=t?this.a:this.read8(r),i=e>=128,n=e<<1&255;t?this.a=n:this.write8(r,n),this.setNZCFlag(n,i)}break;case 28:{const t=2===s.addressing,e=t?this.a:this.read8(r),i=0!=(1&e),n=e>>1&255;t?this.a=n:this.write8(r,n),this.setNZCFlag(n,i)}break;case 29:{const t=this.read8(r),e=this.a&t;this.zero=0===e?1:0,this.negative=t>>j&1,this.overflow=t>>z&1}break;case 30:{const t=this.read8(r),e=this.a-t;this.setNZCFlag(255&e,e>=0)}break;case 31:{const t=this.read8(r),e=this.x-t;this.setNZCFlag(255&e,e>=0)}break;case 32:{const t=this.read8(r),e=this.y-t;this.setNZCFlag(255&e,e>=0)}break;case 33:this.pc=r;break;case 34:this.push16(this.pc-1),this.pc=r;break;case 35:this.pc=this.pop16()+1;break;case 36:this.setStatusReg(this.pop()|G),this.pc=this.pop16();break;case 37:n+=this.branch(r,0===this.carry);break;case 38:n+=this.branch(r,0!==this.carry);break;case 39:n+=this.branch(r,0===this.negative);break;case 40:n+=this.branch(r,0!==this.negative);break;case 41:n+=this.branch(r,0===this.zero);break;case 42:n+=this.branch(r,0!==this.zero);break;case 43:n+=this.branch(r,0===this.overflow);break;case 44:n+=this.branch(r,0!==this.overflow);break;case 45:this.push(this.a);break;case 46:this.push(this.getStatusReg()|K);break;case 47:this.a=this.pop(),this.setNZFlag(this.a);break;case 48:this.setStatusReg(this.pop()|G);break;case 49:this.carry=0;break;case 50:this.carry=1;break;case 51:this.irqBlocked=1;break;case 52:this.irqBlocked=0;break;case 53:this.overflow=0;break;case 54:this.decimal=1;break;case 55:this.decimal=0;break;case 56:this.push16(this.pc+1),this.push(this.getStatusReg()|K),this.pc=this.read16(Y),this.irqBlocked=1}return this.breakPoints[this.pc]&&(this.paused=!0,console.warn(`paused because PC matched break point:${i.a.hex(this.pc,4)}`)),n}getStatusReg(){return this.negative<<j|this.overflow<<z|this.breakmode<<V|this.decimal<<$|this.irqBlocked<<O|this.zero<<F|this.carry<<U}setStatusReg(t){this.negative=t>>j&1,this.overflow=t>>j&1,this.breakmode=t>>V&1,this.decimal=t>>$&1,this.irqBlocked=t>>O&1,this.zero=t>>F&1,this.carry=t>>U&1}read8(t){const e=this.bus.read8(t);return this.watchRead[t]&&(this.paused=!0,console.warn(`Break because watched point read:adr=${i.a.hex(t,4)},value=${i.a.hex(e,2)}`)),e}read16(t){const e=this.read8(t);return this.read8(t+1)<<8|e}read16Indirect(t){const e=this.read8(t);return this.read8((65280&t)+(t+1&255))<<8|e}write8(t,e){this.bus.write8(t,e),this.watchWrite[t]&&(this.paused=!0,console.warn(`Break because watched point write:adr=${i.a.hex(t,4)},value=${i.a.hex(e,2)}`))}push(t){this.write8(256+this.s,t),this.s=tt(this.s)}push16(t){let e=this.s;this.write8(256+e,t>>8),e=tt(e),this.write8(256+e,255&t),this.s=tt(e)}pop(){return this.s=Q(this.s),this.read8(256+this.s)}pop16(){let t=this.s;t=Q(t);const e=this.read8(256+t);t=Q(t);const s=this.read8(256+t);return this.s=t,s<<8|e}setNZFlag(t){this.zero=0===t?1:0,this.negative=t>=128?1:0}setNZCFlag(t,e){this.zero=0===t?1:0,this.negative=t>=128?1:0,this.carry=e?1:0}setOverFlow(t){this.overflow=t?1:0}addStepLog(t){if(this.stepLogs.length<J)this.stepLogs.push(t);else{for(let t=1;t<J;++t)this.stepLogs[t-1]=this.stepLogs[t];this.stepLogs[J-1]=t}}getAdr(t,e){switch(e){case 2:case 1:return 0;case 3:case 14:return t;case 5:return this.read8(t);case 6:return this.read8(t)+this.x&255;case 7:return this.read8(t)+this.y&255;case 8:return this.read16(t);case 9:return this.read16(t)+this.x&65535;case 10:return this.read16(t)+this.y&65535;case 12:{const e=this.read8(t);return this.read16Indirect(e+this.x&255)}case 13:{const e=this.read8(t);return this.read16Indirect(e)+this.y&65535}case 11:{const e=this.read16(t);return this.read16Indirect(e)}default:return console.error(`Illegal addressing:${e}`),this.paused=!0,0}}branch(t,e){if(!e)return 0;const s=this.pc,i=s+((r=this.read8(t))<128?r:r-256)&65535;var r;return this.pc=i,(256&(s^i))>0?2:1}handleIrq(){return this.$DEBUG&&this.addStepLog(`IRQ occurred at pc=${i.a.hex(this.pc,4)}`),this.push16(this.pc),this.push(this.getStatusReg()&~K),this.pc=this.read16(Y),this.irqBlocked=1,!0}}var st,it=s(2);!function(t){t.WIDTH=256,t.HEIGHT=240}(st||(st={}));class rt{constructor(){this.count=0,this.events=new Array}clear(){this.count=0}add(t,e,s,i=-1){const r=this.count;for(let n=r;--n>=0;){const a=this.events[n];if(a.hcount!==t)break;if(a.type===e&&a.index===i){for(let t=n;++t<r;)this.events[t-1]=this.events[t];return this.events[r-1]=a,void(a.value=s)}}if(r>=this.events.length){const r={type:e,value:s,index:i,hcount:t};this.events.push(r)}else{const n=this.events[r];n.type=e,n.value=s,n.index=i,n.hcount=t}++this.count}}class nt{constructor(){this.renderBuf=new rt,this.nextBuf=new rt}clear(){this.renderBuf.clear(),this.nextBuf.clear()}swap(){this.nextBuf.add(st.HEIGHT,0,0);const t=this.renderBuf;this.renderBuf=this.nextBuf,this.nextBuf=t,this.nextBuf.clear(),this.nextBuf.add(0,0,0)}getCount(){return this.renderBuf.count-1}getEvent(t){return this.renderBuf.events[t]}getLastHcount(){const t=this.nextBuf.count;return t<=0?-1:this.nextBuf.events[t-1].hcount}add(t,e,s,i=-1){this.nextBuf.add(t,e,s,i)}}class at{constructor(){this.ppuCtrl=0,this.ppuMask=0,this.chrBankOffset=new Array(8),this.mirrorModeBit=68,this.scrollCurr=0,this.scrollFineX=0,this.reset()}reset(){this.ppuCtrl=0,this.ppuMask=0,this.scrollCurr=0,this.scrollFineX=0;for(let t=0;t<8;++t)this.chrBankOffset[t]=t<<10}copy(t){this.ppuCtrl=t.ppuCtrl,this.ppuMask=t.ppuMask,this.mirrorModeBit=t.mirrorModeBit;for(let e=0;e<8;++e)this.chrBankOffset[e]=t.chrBankOffset[e];this.scrollCurr=t.scrollCurr,this.scrollFineX=t.scrollFineX}set(t,e,s){switch(t){case 0:break;case 1:if(this.ppuCtrl===e)return!1;this.ppuCtrl=e;break;case 2:if(this.ppuMask===e)return!1;this.ppuMask=e;break;case 3:if(this.chrBankOffset[s]===e)return!1;this.chrBankOffset[s]=e;break;case 4:if(this.mirrorModeBit===e)return!1;this.mirrorModeBit=e;break;case 5:if(this.scrollCurr===e)return!1;this.scrollCurr=e;break;case 6:if(this.scrollFineX===e)return!1;this.scrollFineX=e;break;default:return console.error(`ERROR:type=${t}`),!1}return!0}}class ot{constructor(){this.current=new at,this.lastFrame=new at,this.save=new at}reset(){this.current.reset(),this.lastFrame.reset(),this.save.reset()}swap(){const t=this.lastFrame;this.lastFrame=this.save,this.save=t,this.save.copy(this.current)}}const ht=8,ct=16384,lt=256,ut=8,dt=128,pt=32,gt=16,mt=8,ft=4,bt=3,kt=16,wt=8,Ct=4,yt=2,Bt=1,vt=128,Mt=64,xt=32,Et=64,St=64,Pt=128,Tt=16128,qt=16383,At=[80,68,0,85,5],_t=[9,1,0,1,0,2,2,13,8,16,8,36,0,0,4,44,9,1,52,3,0,4,0,20,8,58,0,2,0,32,44,8],Rt=128,It=[Rt,255];function Dt(t,e,s,i){return 8192+(i<<10-(((e>>5&1)+((s/30&1)<<1)^t)<<1)&3072)|0}function Ht(t,e){if(12288<=(t&=16383)&&t<16128&&(t-=4096),8192<=t&&t<12288){return 62463&t|e<<10-((t>>10&3)<<1)&3072}return Tt<=t&&t<=qt&&16144==(65523&(t&=65311))&&(t&=65519),t}function Lt(t,e){return t+(0!=(e&ft)?32:1)&ct-1}function Wt(t){return(t&gt)<<8}function Nt(t,e,s,i){const r=e+s,n=i[r>>10&7]+(1023&r);return it.c[t[n]]|it.c[t[n+8]]<<1}function Ut(t,e,s,i,r){const n=e+(7&s)+((8&s)<<1),a=r[n>>10&7]+(1023&n);let o=t[a+8],h=t[a];return i&&(o=it.b[o],h=it.b[h]),it.c[h]|it.c[o]<<1}function Ft(t,e,s,i){const r=st.WIDTH;for(let n=e;n<s;++n){let e=n*r;for(let s=0;s<i;++s)t[e+s]=0}}class Ot{constructor(){this.suppressSpriteFlicker=!0,this.chrData=new Uint8Array(0),this.regs=new Uint8Array(ht),this.vram=new Uint8Array(ct),this.oam=new Uint8Array(lt),this.mirrorMode=1,this.hcount=0,this.latch=0,this.ppuAddr=0,this.bufferedValue=0,this.hevents=new nt,this.hstatusMgr=new ot,this.scrollTemp=0,this.scrollLatch=0,this.hclipZero=!1,this.offscreen=new Uint8Array(st.WIDTH*st.HEIGHT),this.reset()}reset(){this.regs.fill(0),this.vram.fill(0),this.oam.fill(0),this.hcount=0,this.ppuAddr=0,this.latch=0,this.bufferedValue=0,this.hevents.clear(),this.hstatusMgr.reset(),this.offscreen.fill(0);for(let t=0;t<32;++t)this.vram[Tt+t]=_t[t]}save(){const t={regs:i.a.convertUint8ArrayToBase64String(this.regs),oam:i.a.convertUint8ArrayToBase64String(this.oam),mirrorMode:this.mirrorMode};return this.isChrRam()?t.vram=i.a.convertUint8ArrayToBase64String(this.vram):t.vramHigh=i.a.convertUint8ArrayToBase64String(this.vram.subarray(8192)),t}load(t){const e=this.isChrRam();if(this.regs=i.a.convertBase64StringToUint8Array(t.regs),this.oam=i.a.convertBase64StringToUint8Array(t.oam),this.mirrorMode=t.mirrorMode,e)this.vram=i.a.convertBase64StringToUint8Array(t.vram),this.chrData=this.vram;else{const e=i.a.convertBase64StringToUint8Array(t.vramHigh);for(let t=0;t<e.length;++t)this.vram[t+8192]=e[t]}this.hstatusMgr.current.set(1,this.regs[0],-1),this.hstatusMgr.current.set(2,this.regs[1],-1),this.hstatusMgr.current.set(4,At[this.mirrorMode],-1)}setChrData(t){const e=!(t&&t.length>0);this.chrData=e?this.vram:t}setChrBank(t){const e=t<<3;for(let t=0;t<8;++t)this.setChrBankOffset(t,e+t)}setChrBankOffset(t,e){const s=e<<10&this.chrData.length-1;this.incScrollCounter(),this.addHevent(3,s,t)}getMirrorMode(){return this.mirrorMode}setMirrorMode(t){this.mirrorMode=t;const e=At[t];this.incScrollCounter(),this.addHevent(4,e)}read(t){let e=this.regs[t];switch(t){case 2:this.regs[2]&=~vt,this.latch=0;break;case 4:e=this.oam[this.regs[3]];break;case 7:{const t=this.ppuAddr,s=Ht(t,this.hstatusMgr.current.mirrorModeBit);Tt<=s&&s<=qt?(e=this.readPpuDirect(s),this.bufferedValue=this.readPpuDirect(Ht(t-4096,this.hstatusMgr.current.mirrorModeBit))):(e=this.bufferedValue,this.bufferedValue=this.readPpuDirect(s)),this.ppuAddr=Lt(t,this.regs[0])}}return e}write(t,e){switch(2===t&&(e&=~(vt|Mt|xt)),this.regs[t]=e,t){case 0:{this.incScrollCounter(),this.scrollTemp=-3073&this.scrollTemp|(e&bt)<<10,this.scrollLatch=this.scrollTemp;const t=-1056&this.hstatusMgr.current.scrollCurr|1055&this.scrollTemp;this.addHevent(1,this.regs[0]),this.addHevent(5,t)}break;case 1:this.incScrollCounter(),this.addHevent(2,this.regs[1]);break;case 4:{const t=this.regs[3];this.oam[t]=e,this.regs[3]=t+1&255}break;case 5:if(this.incScrollCounter(),0===this.latch){this.scrollTemp=-32&this.scrollTemp|e>>3,this.scrollLatch=this.scrollTemp,this.addHevent(6,7&e);const t=-1056&this.hstatusMgr.current.scrollCurr|1055&this.scrollTemp;this.addHevent(5,t)}else this.scrollTemp=-29665&this.scrollTemp|(248&e)<<2|(7&e)<<12,this.scrollLatch=this.scrollTemp,this.hclipZero&&this.addHevent(5,this.scrollTemp);this.latch=1-this.latch;break;case 6:0===this.latch?(this.scrollTemp=-32513&this.scrollTemp|(63&e)<<8,this.scrollLatch=this.scrollTemp):(this.scrollTemp=-256&this.scrollTemp|e,this.scrollLatch=this.scrollTemp,this.ppuAddr=this.scrollTemp,this.addHevent(5,this.scrollTemp)),this.latch=1-this.latch;break;case 7:{const t=Ht(this.ppuAddr,this.hstatusMgr.current.mirrorModeBit);this.vram[t]=e,this.ppuAddr=Lt(this.ppuAddr,this.regs[0])}}}copyWithDma(t,e){const s=this.oam;let i=this.regs[3];for(let r=0;r<256;++r)s[i]=t[e+r],i=i+1&255}setVBlank(){this.regs[2]=this.regs[2]|vt,this.hevents.swap(),this.hstatusMgr.swap(),this.hclipZero=!0}clearVBlank(){this.regs[2]&=~(vt|Mt),this.addHevent(5,this.scrollLatch)}interruptEnable(){return 0!=(this.regs[0]&dt)}getSpritePatternTableAddress(){return 0==(this.regs[0]&pt)?(this.regs[0]&mt)<<9:0}setHcount(t){this.hcount=t,this.checkSprite0Hit(t),this.hclipZero&&t<st.HEIGHT&&(this.hclipZero=!1)}render(t){const e=this.hstatusMgr.lastFrame,s=this.hevents.getCount();let i=0;for(let t=0;t<s;++t){const s=this.hevents.getEvent(t);e.set(s.type,s.value,s.index);const r=s.hcount,n=this.hevents.getEvent(t+1).hcount;if(!(r>=n)){if(0==(e.ppuMask&wt))Ft(this.offscreen,r,n,st.WIDTH);else{const t=(3072&e.scrollCurr)>>10,s=Wt(e.ppuCtrl);let i=0;0==(e.ppuMask&yt)&&(i=8,Ft(this.offscreen,r,n,i));const a=e.scrollFineX|(31&e.scrollCurr)<<3,o=(28672&e.scrollCurr)>>12|(992&e.scrollCurr)>>2;this.renderBg(a,o,t,r,n,i,e.chrBankOffset,e.mirrorModeBit,s)}if(0!=(e.ppuMask&kt)){0==(e.ppuCtrl&pt)&&(i=(e.ppuCtrl&mt)<<9);const t=e.ppuMask&Ct?0:8;this.renderSprite(r,n,t,e.chrBankOffset,i)}}}const r=0!=(this.regs[1]&Bt);!function(t,e,s,i){const r=st.WIDTH*st.HEIGHT;let n=0;const a=s?32:63;for(let s=0;s<r;++s){const r=31&t[s],o=3*(i[Tt+r]&a);e[n+0]=it.a[o],e[n+1]=it.a[o+1],e[n+2]=it.a[o+2],n+=4}}(this.offscreen,t,r,this.vram)}renderPattern(t,e,s){const i=0==(this.regs[0]&mt)?1:0,r=new Uint16Array(8);for(let n=0;n<2;++n){const a=n^i,o=s[a]<<2|a<<4|0,h=128*n;for(let s=0;s<16;++s)for(let i=0;i<16;++i){const a=16*(i+16*s+256*n);for(let t=0;t<8;++t){const e=a+t;r[t]=it.c[this.readPpuDirect(e+8)]<<1|it.c[this.readPpuDirect(e)]}const c=this.getPalet(o),l=it.a[3*c+0],u=it.a[3*c+1],d=it.a[3*c+2];this.render8x8Chip(t,8*s*e+8*i+h,r,o,l,u,d,e)}}}writePpuDirect(t,e){if(t>=8192)this.vram[t]=e;else{const s=this.hstatusMgr.current.chrBankOffset[t>>10&7];this.chrData[(1023&t)+s]=e}}dumpVram(t,e){const s=new Array;for(let i=0;i<e;++i)s.push(this.vram[Ht(t+i,this.hstatusMgr.current.mirrorModeBit)]);for(let r=0;r<e;r+=16){const e=s.splice(0,16).map(t=>i.a.hex(t,2)).join(" ");console.log(`${i.a.hex(t+r,4)}:${e}`)}}renderNameTable1(t,e,s,i,r){const n=Wt(this.regs[0]),a=this.vram,o=this.getPalet(0),h=it.a[3*o+0],c=it.a[3*o+1],l=it.a[3*o+2],u=new Uint16Array(8);for(let o=0;o<st.HEIGHT/8;++o){const d=o%30;for(let p=0;p<st.WIDTH/8;++p){const g=31&p,m=Dt(0,p,o,this.hstatusMgr.current.mirrorModeBit)+r,f=16*a[m+g+(d<<5)]+n,b=(2&g)+((2&d)<<1),k=(a[m+960+((g>>2)+(d<<1&248))]>>b&3)<<2;for(let t=0;t<8;++t)u[t]=Nt(this.chrData,f,t,this.hstatusMgr.current.chrBankOffset);this.render8x8Chip(t,(8*o+i)*e+8*p+s,u,k,h,c,l,e)}}}getPalet(t){return 63&this.vram[Tt+(31&t)]}getReg(t){return this.regs[t]}isChrRam(){return this.chrData===this.vram}renderBg(t,e,s,i,r,n,a,o,h){t|=0,e|=0,i|=0,r|=0,n|=0,o|=0;const c=0|st.WIDTH,l=this.vram,u=this.offscreen;e>=240&&(e=e-256|0);const d=7&t,p=t>>3;for(let t=i;t<r;++t){const r=t-i+e,g=(60+(r>>3))%60,m=g%30;for(let e=0;e<st.WIDTH/8+1;++e){const i=e+p&63,f=31&i,b=0|Dt(s,i,g,o),k=(l[b+f+(m<<5)]<<4)+h,w=(2&f)+((2&m)<<1),C=(l[(b+960|0)+((f>>2)+(m<<1&248))]>>w&3)<<2|0,y=8*e-d|0,B=0|Math.max(n-y,0),v=0|Math.min(st.WIDTH-y,8),M=Nt(this.chrData,k,7&r,a);for(let e=B;e<v;++e){let s=M>>14-(e<<1)&3|0;0!==s&&(s|=C),u[t*c+(e+y|0)]=s}}}}isSprite8x16(){return 0!=(this.regs[0]&pt)}renderSprite(t,e,s,i,r){const n=st.WIDTH,a=this.offscreen,o=this.oam,h=this.isSprite8x16(),c=h?16:8;for(let l=t;l<e;++l){let t=0;for(let e=0;e<Et;++e){const u=o[4*e]+1;if(l<u||l>=u+c)continue;const d=o[4*e+1],p=o[4*e+2],g=0!=(p&Pt),m=0!=(p&St),f=o[4*e+3],b=It[p>>5&1],k=h?16*(254&d)+((1&d)<<12):16*d+r,w=(3&p)<<2|16|Rt,C=l-u,y=Math.max(s-f,0),B=Math.min(st.WIDTH-f,8),v=g?c-1-C:C,M=Ut(this.chrData,k,v,m,i);for(let t=y;t<B;++t){const e=M>>(7-t<<1)&3;if(0===e)continue;const s=(u+C)*n+(f+t);0==(a[s]&b)?a[s]=w+e:a[s]|=Rt}if(++t>=ut&&!this.suppressSpriteFlicker)break}}}checkSprite0Hit(t){if(0!=(this.regs[2]&Mt)||(this.regs[1]&(wt|kt))!=(wt|kt))return;const e=this.oam[0];if(t<e||t>=e+16)return;if(this.oam[3]>=255)return;const s=this.getNonEmptySprite0Line();s<0||t!==e+s||(this.regs[2]|=Mt)}getNonEmptySprite0Line(){const t=this.oam,e=this.getSpritePatternTableAddress(),s=this.isSprite8x16(),i=s?16:8,r=t[1],n=0!=(t[2]&Pt),a=s?16*(254&r)+((1&r)<<12):16*r+e;for(let t=0;t<i;++t){const e=n?i-1-t:t;if(0!==Ut(this.chrData,a,e,!1,this.hstatusMgr.current.chrBankOffset))return t}return-1}addHevent(t,e,s=-1){if(!this.hstatusMgr.current.set(t,e,s))return;let i=this.hcount+1;i>=st.HEIGHT&&(i=this.hclipZero?0:st.HEIGHT),this.hevents.add(i,t,e,s)}incScrollCounter(){const t=this.hevents.getLastHcount();if(t<0)return;const e=(this.hcount<st.HEIGHT-1?this.hcount+1:0)-t;if(e<=0)return;const s=t=>{let s=(992&t)>>2|t>>12&7;s>=240&&(s-=256);const i=240*(t>>11&1)+s+e,r=i%240;return-31713&t|(248&r)<<2|(7&r)<<12|(i/240&1)<<11};this.scrollTemp=s(this.scrollTemp),this.addHevent(5,s(this.hstatusMgr.current.scrollCurr))}readPpuDirect(t){if(t>=8192)return this.vram[t];{const e=this.hstatusMgr.current.chrBankOffset[t>>10&7];return this.chrData[(1023&t)+e]}}render8x8Chip(t,e,s,i,r,n,a,o){for(let h=0;h<8;++h){const c=s[h];for(let s=0;s<8;++s){const l=c>>14-(s<<1)&3;let u=r,d=n,p=a;if(0!==l){const t=3*this.getPalet(i|l);u=it.a[t],d=it.a[t+1],p=it.a[t+2]}const g=4*(h*o+s+e);t[g+0]=u,t[g+1]=d,t[g+2]=p}}}}class $t{reset(){}onHblank(t){}save(){return{}}load(t){}getExtraSoundChannelTypes(){return[]}getSoundVolume(t){return 0}getSoundFrequency(t){return 0}getSoundDutyRatio(t){return.5}}class Vt extends $t{static create(t){return new Vt}}const zt=[2,3,1,0];class jt extends $t{constructor(t){super(),this.options=t,this.maxPrg=0,this.ram=new Uint8Array(8192),this.register=0,this.counter=0,this.prgBankMode=3,this.prgReg=0,this.chrBank4k=!0,this.chrBank=[0,4];this.maxPrg=(t.prgSize>>14)-1,this.options.bus.setWriteMemory(32768,65535,(t,e)=>{if(0==(128&e)){if(this.register|=(1&e)<<this.counter,!(++this.counter<5)){switch(57344&t){case 32768:{this.options.ppu.setMirrorMode(zt[3&this.register]),this.prgBankMode=this.register>>2&3,this.setPrgBank(this.prgReg,this.chrBank[0]);const t=0!=(16&this.register);this.chrBank4k!==t&&(this.chrBank4k=t,this.setChrBank(0,this.chrBank[0]),this.setChrBank(1,this.chrBank[1]))}break;case 40960:{const t=this.register;this.chrBank[0]!==t&&this.setChrBank(0,t),this.setPrgBank(this.prgReg,t)}break;case 49152:{const t=this.register;this.chrBank[1]!==t&&this.setChrBank(1,t)}break;case 57344:this.setPrgBank(this.register,this.chrBank[0])}this.resetRegister()}}else this.resetRegister()}),this.ram.fill(191),this.options.bus.setReadMemory(24576,32767,t=>this.ram[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,e)=>{this.ram[8191&t]=e}),this.setPrgBank(0,255)}static create(t){return new jt(t)}save(){return{ram:i.a.convertUint8ArrayToBase64String(this.ram),register:this.register,counter:this.counter,prgBankMode:this.prgBankMode,prgReg:this.prgReg,chrBank4k:this.chrBank4k,chrBank:this.chrBank}}load(t){this.ram=i.a.convertBase64StringToUint8Array(t.ram),this.register=t.register,this.counter=t.counter,this.prgBankMode=t.prgBankMode,this.chrBank4k=t.chrBank4k;for(let e=0;e<2;++e)this.setChrBank(e,t.chrBank[e]);this.setPrgBank(t.prgReg,this.chrBank[0])}resetRegister(){this.register=0,this.counter=0}setChrBank(t,e){if(this.chrBank4k){const s=t<<2,i=e<<2;for(let t=0;t<4;++t)this.options.ppu.setChrBankOffset(s+t,i+t)}else 0===t&&this.options.ppu.setChrBank(e>>1);this.chrBank[t]=e}setPrgBank(t,e){this.prgReg=t;const s=16&e&this.maxPrg,i=(15&t|s)&this.maxPrg;let r,n;switch(this.prgBankMode){case 0:case 1:r=-2&i,n=1|i;break;case 2:r=0,n=i;break;case 3:r=i,n=15&this.maxPrg|s;break;default:return}this.options.prgBankCtrl.setPrgBank(0,r<<1),this.options.prgBankCtrl.setPrgBank(1,1+(r<<1)),this.options.prgBankCtrl.setPrgBank(2,n<<1),this.options.prgBankCtrl.setPrgBank(3,1+(n<<1))}}class Kt extends $t{constructor(t,e){super(),this.options=e,this.bank=0;const s=e.prgSize>>14;this.options.prgBankCtrl.setPrgBank(0,0),this.options.prgBankCtrl.setPrgBank(1,1),this.options.prgBankCtrl.setPrgBank(2,2*s-2),this.options.prgBankCtrl.setPrgBank(3,2*s-1),this.options.bus.setWriteMemory(32768,65535,(e,s)=>{const i=s>>t<<1;this.setBank(i)})}save(){return{bank:this.bank}}load(t){this.setBank(t.bank)}setBank(t){this.bank=t,this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1)}}class Gt extends Kt{static create(t){return new Gt(t)}constructor(t){super(0,t)}}class Zt extends Kt{static create(t){return new Zt(t)}constructor(t){super(4,t)}}class Xt extends $t{constructor(t){super(),this.options=t,this.chrBank=0,this.options.bus.setWriteMemory(32768,65535,(t,e)=>{this.chrBank=e,this.options.ppu.setChrBank(this.chrBank)})}static create(t){return new Xt(t)}save(){return{chrBank:this.chrBank}}load(t){this.chrBank=t.chrBank,this.options.ppu.setChrBank(this.chrBank)}}class Yt extends Xt{static create(t){return new Yt(t)}constructor(t){super(t),t.ppu.writePpuDirect(0,1)}}const Jt=262;class Qt extends $t{constructor(t){super(),this.options=t,this.regs=new Uint8Array(8),this.ram=new Uint8Array(8192),this.maxPrg=0,this.bankSelect=0,this.irqHlineEnable=!1,this.irqHlineValue=-1,this.irqHlineCounter=-1,this.irqLatch=0;this.maxPrg=(t.prgSize>>13)-1,this.options.prgBankCtrl.setPrgBank(3,this.maxPrg),this.ram.fill(255),this.options.bus.setReadMemory(24576,32767,t=>this.ram[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,e)=>{this.ram[8191&t]=e}),this.options.bus.setWriteMemory(32768,40959,(t,e)=>{if(0==(1&t))this.bankSelect=e,this.setPrgBank(this.bankSelect),this.setChrBank(this.bankSelect);else{const t=7&this.bankSelect;this.regs[t]=e,t<6?this.setChrBank(this.bankSelect):this.setPrgBank(this.bankSelect)}}),this.options.bus.setWriteMemory(40960,49151,(t,e)=>{0==(1&t)&&this.options.ppu.setMirrorMode(0==(1&e)?1:0)}),this.options.bus.setWriteMemory(49152,57343,(t,e)=>{0==(1&t)?(this.irqLatch=e,this.setIrqHlineValue(this.irqLatch)):this.setIrqHlineValue(this.irqLatch)}),this.options.bus.setWriteMemory(57344,65535,(t,e)=>{0==(1&t)?(this.enableIrqHline(!1),this.resetIrqHlineCounter()):this.enableIrqHline(!0)}),this.setPrgBank(this.bankSelect);let e=1;switch(this.options.romHash){case"6c0cd447297e95e45db35a4373dbeae1":case"e791b12fc3419a2e2f8a5ed64b210d72":case"44c206c61ff37406815f21b922e105c7":e=0}this.options.ppu.setMirrorMode(e)}static create(t){return new Qt(t)}reset(){this.irqHlineEnable=!1,this.irqHlineValue=this.irqHlineCounter=-1}save(){return{regs:i.a.convertUint8ArrayToBase64String(this.regs),ram:i.a.convertUint8ArrayToBase64String(this.ram),bankSelect:this.bankSelect,irqHlineEnable:this.irqHlineEnable,irqHlineValue:this.irqHlineValue,irqHlineCounter:this.irqHlineCounter,irqLatch:this.irqLatch}}load(t){this.regs=i.a.convertBase64StringToUint8Array(t.regs),this.ram=i.a.convertBase64StringToUint8Array(t.ram),this.bankSelect=t.bankSelect,this.irqHlineEnable=t.irqHlineEnable,this.irqHlineValue=t.irqHlineValue,this.irqHlineCounter=t.irqHlineCounter,this.irqLatch=t.irqLatch,this.setPrgBank(this.bankSelect),this.setChrBank(this.bankSelect)}onHblank(t){switch(0!=(24&this.options.ppu.getReg(1))&&0==--this.irqHlineCounter&&this.irqHlineEnable&&this.options.cpu.requestIrq(),t){case Jt:this.irqHlineCounter=this.irqHlineValue}}setPrgBank(t){0==(64&t)?(this.options.prgBankCtrl.setPrgBank(0,this.regs[6]),this.options.prgBankCtrl.setPrgBank(1,this.regs[7]),this.options.prgBankCtrl.setPrgBank(2,this.maxPrg-1)):(this.options.prgBankCtrl.setPrgBank(2,this.regs[6]),this.options.prgBankCtrl.setPrgBank(1,this.regs[7]),this.options.prgBankCtrl.setPrgBank(0,this.maxPrg-1))}setChrBank(t){0==(128&t)?(this.options.ppu.setChrBankOffset(0,254&this.regs[0]),this.options.ppu.setChrBankOffset(1,1|this.regs[0]),this.options.ppu.setChrBankOffset(2,254&this.regs[1]),this.options.ppu.setChrBankOffset(3,1|this.regs[1]),this.options.ppu.setChrBankOffset(4,this.regs[2]),this.options.ppu.setChrBankOffset(5,this.regs[3]),this.options.ppu.setChrBankOffset(6,this.regs[4]),this.options.ppu.setChrBankOffset(7,this.regs[5])):(this.options.ppu.setChrBankOffset(4,254&this.regs[0]),this.options.ppu.setChrBankOffset(5,1|this.regs[0]),this.options.ppu.setChrBankOffset(6,254&this.regs[1]),this.options.ppu.setChrBankOffset(7,1|this.regs[1]),this.options.ppu.setChrBankOffset(0,this.regs[2]),this.options.ppu.setChrBankOffset(1,this.regs[3]),this.options.ppu.setChrBankOffset(2,this.regs[4]),this.options.ppu.setChrBankOffset(3,this.regs[5]))}setIrqHlineValue(t){this.irqHlineValue=t,this.irqHlineCounter=this.irqHlineValue}enableIrqHline(t){this.irqHlineEnable=t}resetIrqHlineCounter(){this.irqHlineCounter=0}}class te extends Qt{constructor(t){super(t),this.options=t,this.options.bus.setWriteMemory(32768,40959,(t,e)=>{if(0==(1&t))this.bankSelect=7&e,this.setPrgBank(this.bankSelect),this.setChrBank(this.bankSelect);else{const t=7&this.bankSelect;t<6?(e&=63,t>=2&&(e|=64),this.regs[t]=e,this.setChrBank(this.bankSelect)):(this.regs[t]=e,this.setPrgBank(this.bankSelect))}})}static create(t){return new te(t)}}const ee=[2,4,0,3];class se extends Qt{constructor(t){super(t),this.options=t,this.options.bus.setWriteMemory(32768,40959,(t,e)=>{if(0==(1&t))this.bankSelect=7&e;else{const t=7&this.bankSelect;if(t<6){if(this.regs[t]=63&e,this.setChrBank(0),0===t||1===t){const t=this.regs[0]>>5&1,e=this.regs[1]>>4&2;this.options.ppu.setMirrorMode(ee[e|t])}}else this.regs[t]=31&e,this.setPrgBank(0)}})}static create(t){return new se(t)}}class ie extends Qt{static create(t){return new ie(t)}constructor(t){super(t),this.options.bus.setWriteMemory(32768,40959,(t,e)=>{if(0==(1&t))this.bankSelect=e,this.setPrgBank(this.bankSelect),this.setChrBank(this.bankSelect);else{const t=7&this.bankSelect;this.regs[t]=127&e,t<6?this.setChrBank(this.bankSelect):this.setPrgBank(this.bankSelect);const s=128&this.regs[0],i=7&this.regs[0];(0===s&&i<2||0!==s&&i>=2&&i<6)&&this.options.ppu.setMirrorMode(0==(128&e)?2:3)}})}}const re=[2,3];class ne extends $t{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(32768,65535,(t,e)=>{const s=e<<2;for(let t=0;t<4;++t)this.options.prgBankCtrl.setPrgBank(t,s+t);const i=e>>4&1;this.options.ppu.setMirrorMode(re[i])})}static create(t){return new ne(t)}}class ae extends $t{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(40960,49151,(t,e)=>{if(t<45056){const t=e<<1;this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1)}else this.options.ppu.setChrBank(e)}),this.options.bus.setWriteMemory(57344,61440,(t,e)=>{t>=61440&&this.options.ppu.setMirrorMode(0==(1&e)?1:0)});const e=new Uint8Array(8192);e.fill(191),this.options.bus.setReadMemory(24576,32767,t=>e[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,s)=>{e[8191&t]=s})}static create(t){return new ae(t)}}const oe=[1,0,2,3];class he extends $t{constructor(t){super(),this.options=t,this.prgBank=0,this.chrBank=new Uint8Array(8),this.irqEnable=!1,this.irqValue=0,this.irqCounter=0;const e=t.prgSize/16384;this.options.prgBankCtrl.setPrgBank(2,2*e-2),this.options.prgBankCtrl.setPrgBank(3,2*e-1),this.setPrgBank(0),this.options.bus.setWriteMemory(24576,65535,(t,s)=>{const r=15&t;switch(r){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.chrBank[r]=s,this.setChrBank(r,s);break;case 8:this.prgBank=s&e-1,this.setPrgBank(this.prgBank);break;case 9:this.options.ppu.setMirrorMode(oe[3&s]);break;case 10:this.irqEnable=0!=(1&s);break;case 11:case 12:{const t=8*(r-11);this.irqValue=this.irqValue&65280>>t|s<<t,this.irqCounter=this.irqValue}break;default:console.log(`Write ${i.a.hex(t,4)},${i.a.hex(s,2)}`)}})}static create(t){return new he(t)}reset(){this.irqEnable=!1,this.irqValue=this.irqCounter=0}save(){return{prgBank:this.prgBank,chrBank:i.a.convertUint8ArrayToBase64String(this.chrBank),irqEnable:this.irqEnable,irqValue:this.irqValue,irqCounter:this.irqCounter}}load(t){this.prgBank=t.prgBank,this.chrBank=i.a.convertBase64StringToUint8Array(t.chrBank),this.irqEnable=t.irqEnable,this.irqValue=t.irqValue,this.irqCounter=t.irqCounter,this.setPrgBank(this.prgBank);for(let t=0;t<this.chrBank.length;++t)this.setChrBank(t,this.chrBank[t])}onHblank(t){this.irqEnable&&(this.irqCounter-=115,this.irqCounter<=0&&(this.irqCounter+=this.irqValue,this.options.cpu.requestIrq()))}setPrgBank(t){this.options.prgBankCtrl.setPrgBank(0,2*t),this.options.prgBankCtrl.setPrgBank(1,2*t+1)}setChrBank(t,e){this.options.ppu.setChrBankOffset(t,e)}}class ce extends $t{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(32768,49151,(t,e)=>{const s=t>>11&7;this.options.ppu.setChrBankOffset(s,e)}),this.options.bus.setWriteMemory(57344,65535,(t,e)=>{if(t<=63487){const s=(t-57344)/2048;this.options.prgBankCtrl.setPrgBank(s,e)}})}static create(t){return new ce(t)}}const le=1,ue=2,de=4,pe=[1,0,2,3];class ge extends $t{constructor(t,e){super(),this.options=t,this.ram=new Uint8Array(8192),this.prgBankMode=0,this.prgBank=new Array(4),this.chrBank=new Array(8),this.irqControl=0,this.irqLatch=0,this.irqCounter=0;const s=t.prgSize>>13;this.setPrgBank(0,0),this.setPrgBank(1,1),this.setPrgBank(2,s-2),this.setPrgBank(3,s-1),this.options.bus.setWriteMemory(32768,40959,(t,i)=>{if(32768<=t&&t<=32774)switch(this.prgBankMode){case 0:this.setPrgBank(0,i);break;case 1:this.setPrgBank(2,i)}else if(36864==(65280&t)){const r=e[255&t];if(0===r||2===r){const t=3&i;this.options.ppu.setMirrorMode(pe[t])}else if(4===r||6===r)switch(this.prgBankMode=i>>1&1,this.prgBankMode){case 0:this.setPrgBank(2,s-2);break;case 1:this.setPrgBank(0,s-2)}}}),this.options.bus.setWriteMemory(40960,49151,(t,i)=>{if(40960<=t&&t<=40966)this.setPrgBank(1,i&s-1);else if(45056==(65280&t)){const s=e[255&t];0===s?this.setChrBankOffset(0,-16&this.chrBank[0]|15&i):2===s?this.setChrBankOffset(0,-497&this.chrBank[0]|(31&i)<<4):4===s?this.setChrBankOffset(1,-16&this.chrBank[1]|15&i):6===s&&this.setChrBankOffset(1,-497&this.chrBank[1]|(31&i)<<4)}}),this.options.bus.setWriteMemory(49152,65535,(t,s)=>{if(49152<=t&&t<=61439){const i=e[255&t];let r=0,n=!1;if(0===i)r=0;else if(2===i)r=0,n=!0;else if(4===i)r=1;else{if(6!==i)return;r=1,n=!0}const a=2+((12288&t)>>11)+r;let o;o=n?-497&this.chrBank[a]|(31&s)<<4:-16&this.chrBank[a]|15&s,this.setChrBankOffset(a,o)}else{const i=e[255&t];if(0===i)this.irqLatch=-16&this.irqLatch|15&s;else if(2===i)this.irqLatch=-241&this.irqLatch|(15&s)<<4;else if(4===i)this.irqControl=s,0!=(this.irqControl&ue)&&(this.irqCounter=this.irqLatch);else if(6===i){const t=this.irqControl&le;this.irqControl=this.irqControl&~ue|t<<1}}}),this.ram.fill(255),this.options.bus.setReadMemory(24576,32767,t=>this.ram[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,e)=>{this.ram[8191&t]=e})}reset(){this.irqControl=0,this.irqLatch=this.irqCounter=0}save(){return{ram:i.a.convertUint8ArrayToBase64String(this.ram),prgBankMode:this.prgBankMode,prgBank:this.prgBank,chrBank:this.chrBank,irqControl:this.irqControl,irqLatch:this.irqLatch,irqCounter:this.irqCounter}}load(t){this.ram=i.a.convertBase64StringToUint8Array(t.ram),this.prgBankMode=t.prgBankMode,this.irqControl=t.irqControl,this.irqLatch=t.irqLatch,this.irqCounter=t.irqCounter;for(let e=0;e<4;++e)this.setPrgBank(e,t.prgBank[e]);for(let e=0;e<8;++e)this.setChrBankOffset(e,t.chrBank[e])}onHblank(t){if(0!=(this.irqControl&ue)){let t=this.irqCounter;0==(this.irqControl&de)?t+=1:t+=185,t>255&&(t=this.irqLatch,this.options.cpu.requestIrq()),this.irqCounter=t}}setPrgBank(t,e){this.prgBank[t]=e,this.options.prgBankCtrl.setPrgBank(t,e)}setChrBankOffset(t,e){this.chrBank[t]=e,this.options.ppu.setChrBankOffset(t,e)}}class me extends ge{static create(t){return new me(t)}constructor(t){super(t,{0:0,4:2,8:4,12:6,1:2,2:4,3:6})}}class fe extends ge{static create(t){return new fe(t)}constructor(t){super(t,{0:0,1:4,2:2,3:6})}}const be=1,ke=2,we=4,Ce=1789773,ye=241,Be=[1,0,2,3],ve=[[0,1,2,3,4,5,6,7],[0,0,1,1,2,2,3,3],[0,1,2,3,4,4,5,5],[0,1,2,3,4,4,5,5]],Me=[0,0,2];class xe{constructor(){this.regs=new Array(4)}write(t,e){this.regs[t]=e}update(){}getVolume(){return 0}getFrequency(){return 0}}class Ee extends xe{getVolume(){return 0==(128&this.regs[2])?0:(15&this.regs[0])/15}getFrequency(){const t=this.regs[1]|(15&this.regs[2])<<8;return Ce/16/(t+1)|0}}class Se extends xe{constructor(){super(...arguments),this.acc=0,this.count=0}write(t,e){switch(super.write(t,e),t){case 2:this.count=0,0==(128&e)&&(this.acc=0)}}update(){0!=(128&this.regs[2])?(this.acc+=2*(63&this.regs[0]),this.acc>=256&&(this.acc-=256,this.count=0),++this.count,this.count>=7&&(this.acc=0,this.count=0)):this.acc=0}getVolume(){return 0==(128&this.regs[2])?0:1}getFrequency(){const t=this.regs[1]|(15&this.regs[2])<<8;return Ce/14/(t+1)|0}}class Pe extends $t{constructor(t,e){super(),this.options=t,this.ram=new Uint8Array(8192),this.chrRegs=new Uint8Array(8),this.prgCount=0,this.prgBank=0,this.ppuBankMode=0,this.mirrorMode=0,this.irqControl=0,this.irqLatch=0,this.irqCounter=0,this.channels=new Array(Me.length),this.frequencyScaling=0;this.prgCount=t.prgSize>>13,this.options.prgBankCtrl.setPrgBank(0,0),this.options.prgBankCtrl.setPrgBank(1,1),this.setPrgBank(this.prgCount-2),this.options.bus.setWriteMemory(32768,40959,(t,e)=>{32768<=t&&t<=32771?this.setPrgBank((e&this.prgCount/2-1)<<1):36864<=t&&t<=36866?this.writeSound(0,3&t,e):36867===t&&(this.frequencyScaling=e)}),this.options.bus.setWriteMemory(49152,57343,(t,e)=>{49152<=t&&t<=49155&&this.options.prgBankCtrl.setPrgBank(2,e)});const s=45056|e[3];this.options.bus.setWriteMemory(40960,49151,(t,e)=>{(61695&t)===s?(this.ppuBankMode=3&e,this.setChrBank(),this.mirrorMode=e>>2&3,this.options.ppu.setMirrorMode(Be[this.mirrorMode])):40960<=t&&t<=40962?this.writeSound(1,3&t,e):45056<=t&&t<=45058&&this.writeSound(2,3&t,e)}),this.options.bus.setWriteMemory(53248,65535,(t,s)=>{if(53248<=t&&t<=61439){const i=t-53248>>10&4,r=15&t;if(r<4){const t=e[r]+i;this.chrRegs[t]=s,this.setChrBank()}}else{switch(255&t){case 0:this.irqLatch=s;break;case 1:this.irqControl=s,0!=(this.irqControl&ke)&&(this.irqCounter=this.irqLatch);break;case 2:const e=this.irqControl&be;this.irqControl=this.irqControl&~ke|e<<1}}}),this.ram.fill(255),this.options.bus.setReadMemory(24576,32767,t=>this.ram[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,e)=>{this.ram[8191&t]=e}),this.setupAudio()}reset(){this.irqControl=0,this.irqLatch=this.irqCounter=0}save(){return{ram:i.a.convertUint8ArrayToBase64String(this.ram),chrRegs:i.a.convertUint8ArrayToBase64String(this.chrRegs),prgCount:this.prgCount,prgBank:this.prgBank,ppuBankMode:this.ppuBankMode,mirrorMode:this.mirrorMode,irqControl:this.irqControl,irqLatch:this.irqLatch,irqCounter:this.irqCounter}}load(t){this.ram=i.a.convertBase64StringToUint8Array(t.ram),this.chrRegs=i.a.convertBase64StringToUint8Array(t.chrRegs),this.prgCount=t.prgCount,this.ppuBankMode=t.ppuBankMode,this.mirrorMode=t.mirrorMode,this.irqControl=t.irqControl,this.irqLatch=t.irqLatch,this.irqCounter=t.irqCounter,this.setPrgBank(t.prgBank),this.setChrBank()}onHblank(t){if(0!=(this.irqControl&ke)){let t=this.irqCounter;0==(this.irqControl&we)?t+=1:t+=185,t>=255&&(t=this.irqLatch,this.options.cpu.requestIrq()),this.irqCounter=t}t===ye&&this.updateSound()}getExtraSoundChannelTypes(){return Me}getSoundVolume(t){return 0!=(1&this.frequencyScaling)?0:this.channels[t].getVolume()}getSoundFrequency(t){let e=this.channels[t].getFrequency();return 0!=(2&this.frequencyScaling)&&(e*=16),0!=(4&this.frequencyScaling)&&(e*=256),e}setPrgBank(t){this.prgBank=t,this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1)}setChrBank(){const t=ve[this.ppuBankMode];for(let e=0;e<8;++e)this.options.ppu.setChrBankOffset(e,this.chrRegs[t[e]])}writeSound(t,e,s){this.channels[t].write(e,s)}setupAudio(){for(let t=0;t<this.channels.length;++t){let e;switch(Me[t]){case 0:e=new Ee;break;case 2:e=new Se;break;default:continue}this.channels[t]=e}}updateSound(){for(let t of this.channels)t.update()}}class Te extends Pe{static create(t){return new Te(t)}constructor(t){super(t,{0:0,1:1,2:2,3:3})}}class qe extends Pe{static create(t){return new qe(t)}constructor(t){super(t,{0:0,1:2,2:1,3:3})}}const Ae=[1,0];class _e extends $t{constructor(t){super(),this.options=t;const e=(t.prgSize>>13)-1-1;let s=[0,8192],i=0;const r=()=>{let t,r,n;0===i?(t=s[0],r=s[1],n=e):(n=s[0],r=s[1],t=e),this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,r),this.options.prgBankCtrl.setPrgBank(2,n)},n=new Uint8Array(8192);n.fill(191),this.options.bus.setReadMemory(24576,32767,t=>n[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,e)=>{n[8191&t]=e}),this.options.bus.setWriteMemory(32768,40959,(t,e)=>{t<=36863?(s[0]=e,r()):(this.options.ppu.setMirrorMode(Ae[1&e]),i=e>>1&1,r())}),this.options.bus.setWriteMemory(40960,49151,(t,e)=>{t<=45055?(s[1]=e,r()):this.options.ppu.setChrBankOffset(7&t,e)})}static create(t){return new _e(t)}}const Re=[1,0,2,3];class Ie extends $t{constructor(t){super(),this.options=t;let e=0;this.options.bus.setWriteMemory(32768,40959,(t,s)=>{e=15&s}),this.options.bus.setWriteMemory(40960,49151,(t,s)=>{switch(e){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.options.ppu.setChrBankOffset(e,s);break;case 9:case 10:case 11:this.options.prgBankCtrl.setPrgBank(e-9,s);break;case 12:this.options.ppu.setMirrorMode(Re[3&s])}});const s=new Uint8Array(8192);s.fill(191),this.options.bus.setReadMemory(24576,32767,t=>s[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,e)=>{s[8191&t]=e})}static create(t){return new Ie(t)}}class De extends $t{constructor(t){super(),this.options=t,this.ram=new Uint8Array(8192),this.prgBank=0,this.irqEnable=!1,this.irqValue=this.irqCounter=-1;const e=t.prgSize>>14;this.options.prgBankCtrl.setPrgBank(0,0),this.options.prgBankCtrl.setPrgBank(1,1),this.setPrgBank(2*(e-1)),this.options.bus.setWriteMemory(61440,65535,(t,e)=>{this.setPrgBank(e<<1)}),this.options.bus.setWriteMemory(32768,40959,(t,e)=>{this.irqValue=t<36864?65520&this.irqValue|15&e:65295&this.irqValue|(15&e)<<4}),this.options.bus.setWriteMemory(40960,49151,(t,e)=>{this.irqValue=t<45056?61695&this.irqValue|(15&e)<<8:4095&this.irqValue|(15&e)<<12}),this.options.bus.setWriteMemory(49152,57343,(t,e)=>{t<53248&&(this.enableIrq(0!=(2&e)),this.irqCounter=this.irqValue)}),this.ram.fill(255),this.options.bus.setReadMemory(24576,32767,t=>this.ram[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,e)=>{this.ram[8191&t]=e})}static create(t){return new De(t)}reset(){this.irqEnable=!1,this.irqValue=this.irqCounter=-1}save(){return{ram:i.a.convertUint8ArrayToBase64String(this.ram),prgBank:this.prgBank,irqEnable:this.irqEnable,irqValue:this.irqValue,irqCounter:this.irqCounter}}load(t){this.ram=i.a.convertBase64StringToUint8Array(t.ram),this.irqEnable=t.irqEnable,this.irqValue=t.irqValue,this.irqCounter=t.irqCounter,this.setPrgBank(t.prgBank)}onHblank(t){this.irqEnable&&this.irqCounter>0&&(this.irqCounter-=185,this.irqCounter<0&&(this.irqCounter=0,this.options.cpu.requestIrq()))}setPrgBank(t){this.prgBank=t,this.options.prgBankCtrl.setPrgBank(0,t),this.options.prgBankCtrl.setPrgBank(1,t+1)}enableIrq(t){this.irqEnable=t}}class He extends $t{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(24576,32767,(t,e)=>{const s=(2&e)>>1|(1&e)<<1;this.options.ppu.setChrBank(s)})}static create(t){return new He(t)}}class Le extends $t{constructor(t){super(),this.options=t;const e=t.prgSize>>13;for(let t=0;t<4;++t)this.options.prgBankCtrl.setPrgBank(t,e-1);const s=[0,0],i=(t,e)=>{s[t]=e;const i=t<<2,r=e<<2;for(let t=0;t<4;++t)this.options.ppu.setChrBankOffset(i+t,r+t)};this.options.bus.setWriteMemory(32768,40959,(t,e)=>{t<36864?this.options.prgBankCtrl.setPrgBank(0,e):(this.options.ppu.setMirrorMode(0==(1&e)?1:0),i(0,15&s[0]|(2&e)<<3),i(1,15&s[1]|(4&e)<<2))}),this.options.bus.setWriteMemory(40960,49151,(t,e)=>{t<45056&&this.options.prgBankCtrl.setPrgBank(1,e)}),this.options.bus.setWriteMemory(49152,57343,(t,e)=>{t<53248&&this.options.prgBankCtrl.setPrgBank(2,e)}),this.options.bus.setWriteMemory(57344,65535,(t,e)=>{const r=t>>12&1;i(r,16&s[r]|15&e)});const r=new Uint8Array(8192);r.fill(191),this.options.bus.setReadMemory(24576,32767,t=>r[8191&t]),this.options.bus.setWriteMemory(24576,32767,(t,e)=>{r[8191&t]=e})}static create(t){return new Le(t)}}class We extends $t{constructor(t){super(),this.options=t,this.options.bus.setWriteMemory(24576,32767,(t,e)=>{const s=16+(e>>2&28),i=(7&e)<<2;for(let t=0;t<4;++t)this.options.ppu.setChrBankOffset(t+4,s+t);for(let t=0;t<4;++t)this.options.ppu.setChrBankOffset(t,i+t)})}static create(t){return new We(t)}}const Ne={0:Vt.create,1:jt.create,2:Gt.create,3:Xt.create,4:Qt.create,7:ne.create,10:ae.create,16:he.create,19:ce.create,23:me.create,24:Te.create,25:fe.create,26:qe.create,32:_e.create,69:Ie.create,73:De.create,75:Le.create,87:He.create,88:te.create,93:Zt.create,95:se.create,118:ie.create,184:We.create,185:Yt.create,206:Qt.create};var Ue=s(34);s.d(e,"a",function(){return Ze});const Fe=2048,Oe=241,$e=242,Ve=261,ze=262,je=341*ze/3|0,Ke=16404;function Ge(t){return t*(3/341)|0}class Ze{constructor(){this.ram=new Uint8Array(Fe),this.cycleCount=0,this.mapperNo=0,this.prgRom=new Uint8Array(0),this.prgBank=[],this.apuChannelCount=0,this.bus=new L,this.cpu=new et(this.bus),this.ppu=new Ot,this.apu=new D(()=>{this.cpu.requestIrq()}),this.vblankCallback=t=>{},this.breakPointCallback=()=>{},this.mapperNo=0,this.mapper=this.createMapper(this.mapperNo)}static create(){return new Ze}getPaletColorTable(){return it.a}getBus(){return this.bus}getCpu(){return this.cpu}getPpu(){return this.ppu}getCycleCount(){return this.cycleCount}setVblankCallback(t){this.vblankCallback=t}setBreakPointCallback(t){this.breakPointCallback=t}setRomData(t){if(!function(t){return 78===t[0]&&69===t[1]&&83===t[2]&&26===t[3]}(t))return"Invalid format";if(this.mapperNo=function(t){return t[6]>>4&15|240&t[7]}(t),!(this.mapperNo in Ne))return`Mapper ${this.mapperNo}not supported`;this.prgRom=function(t){const e=16384*t[4],s=t.slice(16,16+e);return new Uint8Array(s)}(t),this.ppu.setChrData(function(t){const e=16+16384*t[4],s=8192*t[5],i=t.slice(e,e+s);return new Uint8Array(i)}(t)),this.ppu.setMirrorMode(0==(1&t[6])?0:1),this.cpu.deleteAllBreakPoints(),this.setMemoryMap();const e=Ue(t);return this.mapper=this.createMapper(this.mapperNo,e),!0}save(){return{cpu:this.cpu.save(),ppu:this.ppu.save(),apu:this.apu.save(),mapper:null!=this.mapper?this.mapper.save():null,ram:i.a.convertUint8ArrayToBase64String(this.ram)}}load(t){this.reset(),this.cpu.load(t.cpu),this.ppu.load(t.ppu),this.apu.load(t.apu),this.mapper.load(t.mapper),this.ram=i.a.convertBase64StringToUint8Array(t.ram)}reset(){this.ram.fill(255),this.cpu.reset(),this.ppu.reset(),this.apu.reset(),this.cycleCount=0,null!=this.mapper&&this.mapper.reset()}setPadStatus(t,e){this.apu.setPadStatus(t,e)}runCycles(t){try{let e=t;for(;e>0;){if(e-=this.step(e),this.cpu.isPaused())return this.breakPointCallback(),0}return-t}catch(t){throw this.cpu.pause(!0),t}}step(t){const e=this.cpu.step();return this.cycleCount=this.tryHblankEvent(this.cycleCount,e,t),e}getSoundChannelTypes(){const t=this.apu.getChannelTypes(),e=this.mapper.getExtraSoundChannelTypes();return this.apuChannelCount=t.length,t.concat(e)}getSoundVolume(t){return t<this.apuChannelCount?this.apu.getVolume(t):this.mapper.getSoundVolume(t-this.apuChannelCount)}getSoundFrequency(t){return t<this.apuChannelCount?this.apu.getFrequency(t):this.mapper.getSoundFrequency(t-this.apuChannelCount)}getSoundDutyRatio(t){return t<this.apuChannelCount?this.apu.getDutyRatio(t):this.mapper.getSoundDutyRatio(t-this.apuChannelCount)}render(t){this.ppu.render(t)}renderNameTable1(t,e,s,i,r){this.ppu.renderNameTable1(t,e,s,i,r<<10)}renderPatternTable(t,e,s){this.ppu.renderPattern(t,e,s)}setPrgBank(t,e){this.prgBank[t]=e<<13}setMemoryMap(){const t=this.bus;t.clearMemoryMap(),t.setReadMemory(8192,16383,t=>{const e=7&t;return this.ppu.read(e)}),t.setWriteMemory(8192,16383,(t,e)=>{const s=7&t;this.ppu.write(s,e)}),t.setReadMemory(16384,24575,t=>this.apu.read(t)),t.setWriteMemory(16384,24575,(t,e)=>{switch(t){case Ke:0<=e&&e<=31?this.ppu.copyWithDma(this.ram,e<<8):console.error(`OAMDMA not implemented except for RAM:${i.a.hex(e,2)}`);break;default:this.apu.write(t,e)}});const e=this.prgRom.length-1|0;this.prgBank=[0,8192,-16384&e,-8192&e],t.setReadMemory(32768,65535,t=>{const s=(t|=0)-32768>>13,i=8191&t|0;return 0|this.prgRom[(0|this.prgBank[s])+i&e]}),t.setReadMemory(0,8191,t=>this.ram[t&Fe-1]),t.setWriteMemory(0,8191,(t,e)=>{this.ram[t&Fe-1]=e})}createMapper(t,e){return(0,Ne[t])({bus:this.bus,cpu:this.cpu,ppu:this.ppu,prgBankCtrl:this,prgSize:this.prgRom.length,romHash:e})}tryHblankEvent(t,e,s){let i=t+e;const r=Ge(t);let n=Ge(i);if(n>r){switch(this.ppu.setHcount(n),this.apu.onHblank(n),n){case Oe:this.ppu.setVBlank(),this.vblankCallback(s/je|0);break;case $e:this.interruptVBlank();break;case Ve:this.ppu.clearVBlank();break;case ze:i-=341*ze/3|0,this.ppu.setHcount(0)}this.mapper.onHblank(n)}return i}interruptVBlank(){this.ppu.interruptEnable()&&this.interruptNmi()}interruptNmi(){this.cpu.nmi()}}},26:function(t,e,s){"use strict";var i=s(4),r=s(1);const n=256,a=240;function o(t,e){const s=document.createElement("canvas");return s.className="full-size",s.width=t,s.height=e,r.a.setStyles(s,{display:"block"}),r.a.clearCanvas(s),s}function h(t){for(let e=0,s=t.width*t.height*4;e<s;++e)t[4*e+0]=0,t[4*e+1]=0,t[4*e+2]=0,t[4*e+3]=255}class c{getCanvas(){return this.canvas}reset(){r.a.clearCanvas(this.canvas)}}class l extends c{constructor(){super(),this.canvas=o(n,a),this.context=r.a.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.canvas.classList.add("pixelated")}render(t){t.render(this.imageData.data),this.context.putImageData(this.imageData,0,0)}}class u extends c{constructor(){super(),this.canvas=o(n,2*a),this.context=r.a.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),h(this.imageData),this.orgImageData=new ImageData(n,a),h(this.orgImageData)}render(t){t.render(this.orgImageData.data);const e=this.orgImageData.data,s=this.imageData.data;for(let t=0;t<a;++t){let i=t*(4*n),r=2*i;for(let t=0;t<n;++t)s[r+0]=e[i+0],s[r+1]=e[i+1],s[r+2]=e[i+2],i+=4,r+=4;i=t*(4*n);for(let t=0;t<n;++t)s[r+0]=e[i+0]>>1,s[r+1]=e[i+1]>>1,s[r+2]=e[i+2]>>1,i+=4,r+=4}this.context.putImageData(this.imageData,0,0)}}class d extends c{constructor(){super(),this.canvas=o(2*n,2*a),this.context=r.a.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),h(this.imageData),this.orgImageData=new ImageData(n,a),h(this.orgImageData)}render(t){t.render(this.orgImageData.data);const e=this.orgImageData.data,s=this.imageData.data;for(let t=0;t<a;++t){const i=0|Math.max(t-1,0),r=0|Math.min(t+1,a-1);for(let a=0;a<n;++a){const o=0|Math.max(a-1,0),h=0|Math.min(a+1,n-1),c=4*(t*n+a),l=4*(i*n+a),u=4*(r*n+a),d=4*(t*n+o),p=4*(t*n+h),g=e[c+0]<<16|e[c+1]<<8|e[c+2],m=e[l+0]<<16|e[l+1]<<8|e[l+2],f=e[u+0]<<16|e[u+1]<<8|e[u+2],b=e[d+0]<<16|e[d+1]<<8|e[d+2],k=e[p+0]<<16|e[p+1]<<8|e[p+2];let w=g,C=g,y=g,B=g;b===m&&b!==f&&m!==k&&(w=m),m===k&&m!==b&&k!==f&&(C=k),f===b&&f!==k&&b!==m&&(y=b),k===f&&k!==m&&f!==b&&(B=f);const v=8*(t*(2*n)+a);s[v+0]=w>>16,s[v+1]=w>>8&255,s[v+2]=255&w,s[v+4]=C>>16,s[v+5]=C>>8&255,s[v+6]=255&C,s[v+(0+8*n)]=y>>16,s[v+(1+8*n)]=y>>8&255,s[v+(2+8*n)]=255&y,s[v+(4+8*n)]=B>>16,s[v+(5+8*n)]=B>>8&255,s[v+(6+8*n)]=255&B}}this.context.putImageData(this.imageData,0,0)}}s.d(e,"a",function(){return k});const p=256,g=240,m=0,f=8;function b(t,e,s){return t/e>=s?t=e*s:e=t/s,[t,e]}class k extends i.a{constructor(t,e,s,n){super(t,2*(p-2*m),2*(g-2*f)+i.a.MENUBAR_HEIGHT,"NES"),this.app=e,this.nes=s,this.stream=n,this.hideEdge=!0,this.contentWidth=0,this.contentHeight=0,this.scalerType=0,null!=e&&null!=s&&null!=n&&(this.setUpMenuBar(),this.contentHolder.style.overflow="hidden",this.fullscreenBase=document.createElement("div"),this.fullscreenBase.className="full-size",r.a.setStyles(this.fullscreenBase,{position:"relative",overflow:"hidden"}),this.setContent(this.fullscreenBase),this.canvasHolder=document.createElement("div"),r.a.setStyles(this.canvasHolder,{transitionDuration:"0.1s",transitionProperty:"width, height"}),this.fullscreenBase.appendChild(this.canvasHolder),this.setScaler(0),this.addResizeBox(),this.subscription=this.stream.subscribe(t=>{switch(t){case 1:this.render();break;case 5:this.scaler.reset()}}),this.contentWidth=2*(p-2*m),this.contentHeight=2*(g-2*f),this.updateContentSize(this.contentWidth,this.contentHeight))}onEvent(t,e){switch(t){case"resize":{const{width:t,height:s}=e;this.onResized(t,s)}break;case"openMenu":this.onOpenMenu();break;case"closeMenu":this.onCloseMenu()}}onResized(t,e){this.contentWidth=t,this.contentHeight=e,this.updateContentSize(t,e-i.a.MENUBAR_HEIGHT)}setClientSize(t,e){return t=Math.round(t),e=Math.round(e),super.setClientSize(t,e),this.contentWidth=t,this.contentHeight=e,this.updateContentSize(t,e),this}capture(){return this.scaler.getCanvas().toDataURL()}setFullscreen(t){return this.wndMgr.setFullscreen(this.contentHolder,e=>{if(e){let t=window.parent.screen.width,e=window.parent.screen.height;t/e>=p/g?t=e*(p/g)|0:e=t*(g/p)|0,r.a.setStyles(this.fullscreenBase,{width:`${t}px`,height:`${e}px`,margin:"auto"}),this.contentHolder.style.backgroundColor="black",this.updateContentSize(t,e)}else r.a.setStyles(this.fullscreenBase,{width:"",height:"",margin:""}),this.contentHolder.style.backgroundColor="",this.updateContentSize(this.contentWidth,this.contentHeight);t&&t(e),this.contentHolder.focus()})}close(){null!=this.subscription&&this.subscription.unsubscribe(),this.stream.triggerCloseWnd(this),super.close()}render(){this.scaler.render(this.nes)}setClientScale(t){const e=(p-(this.hideEdge?2*m:0))*t|0,s=(g-(this.hideEdge?2*f:0))*t|0;return this.setClientSize(e,s)}updateContentSize(t,e){if(!this.fullscreenBase)return;const s=this.hideEdge?t*(p/(p-2*m))|0:t,i=this.hideEdge?e*(g/(g-2*f))|0:e,n=this.hideEdge?-s*m/p|0:0,a=this.hideEdge?-i*f/g|0:0;r.a.setStyles(this.canvasHolder,{position:"absolute",width:"100%",height:"100%",top:"0px",left:"0px"})}setUpMenuBar(){this.menuItems=[{label:"File",submenu:[{label:"Pause",click:()=>{this.nes.getCpu().isPaused()?this.stream.triggerRun():this.stream.triggerPause()}},{label:"Reset",click:()=>{this.stream.triggerReset(),this.stream.triggerRun()}},{label:"Screenshot",click:()=>{!function(t,e){const s=document.createElement("img"),r=String(Date.now());s.src=e.capture(),s.className="pixelated full-size",s.title=s.alt=r;const n=new i.a(t,p,g,r);n.setContent(s),n.addResizeBox(),t.add(n)}(this.wndMgr,this)}},{label:"Save",click:()=>{if(this.app.saveData()){this.menuItems[0].submenu[4].disabled=!1}}},{label:"Load",click:()=>{this.app.loadData()}},{label:"Quit",click:()=>{this.close()}}]},{label:"View",submenu:[{label:"1x1",click:()=>{this.setClientScale(1)}},{label:"2x2",click:()=>{this.setClientScale(2)}},{label:"Adjust aspect ratio",click:()=>{this.adjustAspectRatio()}},{label:"Fullscreen",click:()=>{this.setFullscreen()}}]},{label:"Scaler",submenu:[{label:"Nearest",click:()=>{this.setScaler(0)}},{label:"Scanline",click:()=>{this.setScaler(1)}},{label:"Epx",click:()=>{this.setScaler(2)}}]},{label:"Debug",submenu:[{label:"Edge",click:()=>{this.toggleEdge()}},{label:"Sprite flicker",click:()=>{this.toggleSpriteFlicker()}},{label:"Palette",click:()=>{this.app.createPaletWnd()}},{label:"NameTable",click:()=>{this.app.createNameTableWnd()}},{label:"PatternTable",click:()=>{this.app.createPatternTableWnd()}},{label:"Trace",click:()=>{this.app.createTraceWnd()}},{label:"Registers",click:()=>{this.app.createRegisterWnd()}},{label:"Control",click:()=>{this.app.createControlWnd()}},{label:"FPS",click:()=>{this.app.createFpsWnd()}}]}],this.addMenuBar(this.menuItems)}onOpenMenu(){const t=this.contentHolder.getBoundingClientRect(),e=p-(this.hideEdge?2*m:0)|0,s=g-(this.hideEdge?2*f:0)|0,i=this.menuItems[0].submenu;"disabled"in i[4]||(i[4].disabled=!this.app.hasSaveData());const r=this.menuItems[1].submenu;r[0].checked=Math.abs(t.width-e)<.5&&Math.abs(t.height-s)<.5,r[1].checked=Math.abs(t.width-2*e)<.5&&Math.abs(t.height-2*s)<.5,r[2].disabled=Math.abs(t.width/t.height-e/s)<.005;const n=this.menuItems[2].submenu;for(let t=0;t<n.length;++t)n[t].checked=this.scalerType===t;const a=this.nes.getPpu(),o=this.menuItems[3].submenu;o[0].checked=!this.hideEdge,o[1].checked=!a.suppressSpriteFlicker,this.stream.triggerOpenMenu()}onCloseMenu(){this.stream.triggerCloseMenu()}maximize(){const t=window.innerWidth,e=window.innerHeight,s=t-2,r=e-i.a.TITLEBAR_HEIGHT-i.a.MENUBAR_HEIGHT-2,n=Math.round(p-(this.hideEdge?2*m:0)),a=Math.round(g-(this.hideEdge?2*f:0)),[o,h]=b(s,r,n/a),c=(t-(o+2))/2,l=(e-(h+i.a.TITLEBAR_HEIGHT+i.a.MENUBAR_HEIGHT+2))/2;this.setPos(Math.round(c),Math.round(l)),this.setClientSize(o,h)}adjustAspectRatio(){const t=this.contentHolder.getBoundingClientRect(),e=p-(this.hideEdge?2*m:0),s=g-(this.hideEdge?2*f:0),[i,r]=b(t.width,t.height,e/s);this.setClientSize(i,r)}toggleEdge(){this.hideEdge=!this.hideEdge,this.updateContentSize(this.contentHolder.offsetWidth,this.contentHolder.offsetHeight)}toggleSpriteFlicker(){const t=this.nes.getPpu();t.suppressSpriteFlicker=!t.suppressSpriteFlicker}setScaler(t){const e=null==this.scaler;if(this.scalerType!==t||e){switch(this.scalerType=t,t){case 0:this.scaler=new l;break;case 1:this.scaler=new u;break;case 2:this.scaler=new d}r.a.removeAllChildren(this.canvasHolder),this.canvasHolder.appendChild(this.scaler.getCanvas()),e||this.render()}}}},39:function(t,e){},4:function(t,e,s){"use strict";s.d(e,"a",function(){return h});var i=s(1),r=s(0);const n=1e3,a=n+1;function o(t,e){const s=document.createElement("div");s.className="upper",i.a.setStyles(s,{position:"absolute",overflow:"hidden",left:0,top:0,right:0,height:`${e}px`});const r=document.createElement("div");return r.className="lower",i.a.setStyles(r,{position:"absolute",overflow:"hidden",left:0,bottom:"8px",right:0,top:"8px"}),t.appendChild(r),[s,r]}class h{constructor(t,e,s,i){this.wndMgr=t,this.clientMarginWidth=0,this.clientMarginHeight=0,this.bTop=!1,this.root=this.createRoot(),this.root.className="wnd",this.root.style.position="absolute";const[r,n]=o(this.root,h.TITLEBAR_HEIGHT);this.clientMarginHeight+=h.TITLEBAR_HEIGHT,this.titleBar=this.createTitleBar(i),r.appendChild(this.titleBar),this.contentHolder=n,this.setClientSize(e,s)}setContent(t){return i.a.removeAllChildren(this.contentHolder),this.contentHolder.appendChild(t),this}getContentHolder(){return this.contentHolder}getRootElement(){return this.root}setPos(t,e){return i.a.setStyles(this.root,{left:`${t}px`,top:`${e}px`}),this}setTitle(t){return this.titleElem.innerText=t,this}setClientSize(t,e){return i.a.setStyles(this.root,{width:"100%",height:"100%"}),this}getWindowSize(){return{width:parseInt(this.root.style.width||"-1",10),height:parseInt(this.root.style.height||"-1",10)}}onEvent(t,e){}setFocus(){return this.root.focus(),this}isTop(){return this.bTop}setTop(t){this.bTop=t,t?this.root.classList.add("top"):this.root.classList.remove("top")}addMenuBar(t){const[e,s]=o(this.root,h.MENUBAR_HEIGHT);this.clientMarginHeight+=h.TITLEBAR_HEIGHT,this.contentHolder.appendChild(e),this.contentHolder.appendChild(s),this.menuBar=document.createElement("div"),this.menuBar.className="menu-bar",this.menuBar.style.zIndex=String(n);const i=[];let r,a=-1;const c=()=>{a=-1,r=null,this.onEvent("closeMenu")},l=e=>{const s=t[e];if(!("submenu"in s)||a===e)return;null!=r&&r.close();const n=i[e];a=e,r=this.openSubmenu(s,n,c)};return t.forEach((t,e)=>{const s=document.createElement("div");s.className="menu-item pull-left",s.innerText=t.label,s.style.height="100%",s.addEventListener("click",s=>{s.stopPropagation(),"submenu"in t&&(a<0?(this.onEvent("openMenu"),l(e)):(r.close(),c()))}),this.menuBar.appendChild(s),i.push(s),s.addEventListener("mouseenter",s=>{a>=0&&a!==e&&"submenu"in t&&l(e)})}),e.appendChild(this.menuBar),this.contentHolder=s,this}getRootNode(){return this.root}close(){!1!==this.onEvent("close")&&this.wndMgr.remove(this)}addResizeBox(){}maximize(){this.setPos(0,0);const t=null!=this.menuBar?h.MENUBAR_HEIGHT:0,e=window.innerWidth-2,s=window.innerHeight-(h.TITLEBAR_HEIGHT+t)-2;this.setClientSize(e,s)}createRoot(){const t=document.createElement("div");return t.addEventListener("mousedown",t=>(t.stopPropagation(),this.wndMgr.moveToTop(this),!1)),t}createTitleBar(t){const e=document.createElement("div");return e.className="title-bar clearfix",this.titleElem=this.addTitle(e,t),this.addTitleButton(e,"close",()=>{this.close()}),e.addEventListener("mousedown",t=>{if(0!==t.button)return!1;t.preventDefault();let[e,s]=i.a.getMousePosIn(t,this.root);const n=-e,a=-s,o=this.getWindowSize();return i.a.setMouseDragListener({move:t=>{let[e,s]=i.a.getMousePosIn(t,this.root.parentNode);e=r.a.clamp(e,-n,window.innerWidth-o.width-n),s=r.a.clamp(s,-a,window.innerHeight-o.height-a),i.a.setStyles(this.root,{left:`${Math.round(e+n)}px`,top:`${Math.round(s+a)}px`})}}),!0}),e}addTitleButton(t,e,s){const i=document.createElement("div");return i.className=`${e}btn`,i.title=e,i.addEventListener("click",s),i.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation()}),t.appendChild(i),i}addTitle(t,e){const s=document.createElement("div");return s.className="title",s.appendChild(document.createTextNode(e)),t.appendChild(s),s}openSubmenu(t,e,s){const r=document.createElement("div");r.className="menu-subitem-holder",r.style.zIndex=String(a),t.submenu.forEach(t=>{const e=document.createElement("div");if(e.className="submenu-row clearfix",t.checked){const t=document.createElement("div");t.className="submenu-check",e.appendChild(t)}const s=document.createElement("div");s.innerText=t.label,t.disabled?s.className="menu-item disabled":(s.className="menu-item",s.addEventListener("click",e=>{t.click&&t.click()})),e.appendChild(s),r.appendChild(e)}),this.root.appendChild(r);const n=function(t,e){const s=t.getBoundingClientRect(),i=e.getBoundingClientRect();return{left:i.left-s.left,top:i.top-s.top,right:i.right-s.left,bottom:i.bottom-s.top}}(this.root,e);i.a.setStyles(r,{left:`${n.left-1}px`,top:`${n.bottom-1}px`});const o=()=>{null!=r.parentNode&&r.parentNode.removeChild(r),document.removeEventListener("click",h)},h=t=>{o(),null!=s&&s()};return document.addEventListener("click",h),{close:o}}}h.TITLEBAR_HEIGHT=0,h.MENUBAR_HEIGHT=0},6:function(t,e,s){"use strict";class i extends Storage{constructor(){super(),this.storage={}}setItem(t,e){this.storage[t]=String(e)}getItem(t){const e=this.storage[t];return void 0===e?null:e}removeItem(t){delete this.storage[t]}get length(){return Object.keys(this.storage).length}key(t){return Object.keys(this.storage)[t]}}s.d(e,"a",function(){return o});let r=window.localStorage,n="";if(null==r){try{"localStorage"in window&&null!=window.localStorage&&(r=window.localStorage)}catch(t){}null==r&&(r=new i)}function a(t){return`${n}${t}`}class o{static setKeyPrefix(t){n=t}static hasKey(t){const e=a(t);return null!=r.getItem(e)}static get(t,e){const s=a(t);return r.getItem(s)||e}static getInt(t,e){const s=a(t),i=r.getItem(s);if(null==i)return e;const n=parseInt(i,10);return isNaN(n)?e:n}static getFloat(t,e){const s=a(t),i=r.getItem(s);if(null==i)return e;const n=parseFloat(i);return isNaN(n)?e:n}static getBool(t,e){const s=a(t),i=r.getItem(s);return"true"===i||"false"!==i&&e}static getObject(t,e){const s=a(t),i=r.getItem(s);try{if(null!=i)return JSON.parse(i)}catch(t){console.error(t)}return e}static put(t,e){const s=a(t);return r.setItem(s,e),!0}static putObject(t,e){const s=a(t);return r.setItem(s,JSON.stringify(e)),!0}}},61:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",function(){return JsApp});var _app__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(18),_util_audio_manager__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(24),_util_dom_util__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1),_nes_nes__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(25),_screen_wnd__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(26),_util_util__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(0);const WIDTH=256,HEIGHT=240,MAX_FRAME_COUNT=4;class JsNes extends _nes_nes__WEBPACK_IMPORTED_MODULE_3__.a{constructor(){super(),this.reset()}setFile(t){return null==t?Promise.reject("null"):(this.file=t,this.setMemoryMap(),this.mapperNo=0,this.mapper=this.createMapper(this.mapperNo),this.reload())}reload(){return _util_dom_util__WEBPACK_IMPORTED_MODULE_2__.a.loadFile(this.file).then(data=>{const jsCode=new TextDecoder("utf-8").decode(data);return this.jsCpu=eval(jsCode),this.ppu.setChrData(this.jsCpu.getChrRom()),this.jsCpu.init(this.bus,this.ppu),Promise.resolve()})}reset(){this.ram.fill(255),this.ppu.reset(),this.apu.reset(),null!=this.jsCpu&&this.jsCpu.reset()}update(){this.jsCpu.update()}step(t){return this.jsCpu.step(),1}}class JsScreenWnd extends _screen_wnd__WEBPACK_IMPORTED_MODULE_4__.a{constructor(t,e,s,i){super(t,e,s,i),this.jsApp=e,this.jsNes=s,this.canvas=JsScreenWnd.createCanvas(WIDTH,HEIGHT),this.context=_util_dom_util__WEBPACK_IMPORTED_MODULE_2__.a.getCanvasContext2d(this.canvas),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.canvas.className="pixelated full-size",this.setContent(this.canvas)}static createCanvas(t,e){const s=document.createElement("canvas");return s.width=t,s.height=e,s.className="full-size",_util_dom_util__WEBPACK_IMPORTED_MODULE_2__.a.setStyles(s,{display:"block"}),_util_dom_util__WEBPACK_IMPORTED_MODULE_2__.a.clearCanvas(s),s}render(){this.jsNes.render(this.imageData.data),this.context.putImageData(this.imageData,0,0)}setUpMenuBar(){this.addMenuBar([{label:"File",submenu:[{label:"Pause",click:()=>{this.jsNes.jsCpu.isPaused()?this.stream.triggerRun():this.stream.triggerPause()}},{label:"Reset",click:()=>{this.stream.triggerReset()}},{label:"Reload",click:()=>{this.jsApp.reload()}},{label:"Quit",click:()=>{this.close()}}]},{label:"Debug",submenu:[{label:"Palette",click:()=>{this.app.createPaletWnd()}},{label:"NameTable",click:()=>{this.app.createNameTableWnd()}},{label:"PatternTable",click:()=>{this.app.createPatternTableWnd()}},{label:"Control",click:()=>{this.app.createControlWnd()}}]}])}}class JsApp extends _app__WEBPACK_IMPORTED_MODULE_0__.a{constructor(t,e){super(t,e,!0),this.leftTime=0,this.jsNes=new JsNes,window.jsNes=this.jsNes,this.jsScreenWnd=new JsScreenWnd(this.wndMgr,this,this.jsNes,this.stream),this.wndMgr.add(this.jsScreenWnd),e.title&&this.jsScreenWnd.setTitle(e.title),this.subscription=this.stream.subscribe((t,e)=>this.handleAppEvent(t,e)),this.nes=this.jsNes,this.wndMap[1]=this.screenWnd=this.jsScreenWnd;const s=this.screenWnd.getWindowSize();let i=_util_util__WEBPACK_IMPORTED_MODULE_5__.a.clamp((e.centerX||0)-s.width/2,0,window.innerWidth-s.width-1),r=_util_util__WEBPACK_IMPORTED_MODULE_5__.a.clamp((e.centerY||0)-s.height/2,0,window.innerHeight-s.height-1);this.screenWnd.setPos(i,r)}handleAppEvent(t,e){switch(t){case 2:this.jsNes.jsCpu.pause(!1);break;case 3:this.jsNes.jsCpu.pause(!0);break;case 4:this.jsNes.step();break;case 5:this.jsNes.reset();break;default:return super.handleAppEvent(t,e)}}setFile(t){this.cancelLoopAnimation(),this.jsNes.setFile(t).then(()=>{const t=window.AudioContext||window.webkitAudioContext;this.audioManager=new _util_audio_manager__WEBPACK_IMPORTED_MODULE_1__.a(t),this.setupAudioManager(),this.audioManager.setMasterVolume(this.volume*_app__WEBPACK_IMPORTED_MODULE_0__.b),this.startLoopAnimation()})}reload(){this.cancelLoopAnimation(),this.jsNes.reload(),this.startLoopAnimation()}startLoopAnimation(){if(null!=this.rafId)return;let t=window.performance.now();const e=()=>{if(this.destroying)return;const s=window.performance.now(),i=s-t;t=s,this.update(i),this.rafId=requestAnimationFrame(e)};this.rafId=requestAnimationFrame(e)}cancelLoopAnimation(){null!=this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0)}update(t){for(let t=0;t<2;++t){const e=this.wndMgr.getPadStatus(this.screenWnd,t);this.nes.setPadStatus(t,e)}let e=t+this.leftTime,s=60*e/1e3|0;if(s<=MAX_FRAME_COUNT?this.leftTime=e-(1e3*s/60|0):(s=MAX_FRAME_COUNT,this.leftTime=0),(s=this.wndMgr.getKeyPressing(this.screenWnd,16)?4*s:s)>0){const t=this.jsNes.getPpu();for(let e=0;e<s;++e)t.clearVBlank(),this.jsNes.update(),this.updateAudio(),t.setHcount(240),t.setVBlank();this.jsScreenWnd.render(),this.stream.triggerRender()}}}}});